---
title: "Spring03"
description: "spring03"
keywords: "spring03"

date: 2023-10-08T16:40:26+08:00
lastmod: 2023-10-08T16:40:26+08:00

categories:
  - å­¦ä¹ ç¬”è®°
tags:
  - spring


# åŸæ–‡ä½œè€…
author: zzzi
# å¼€å¯æ•°å­¦å…¬å¼æ¸²æŸ“ï¼Œå¯é€‰å€¼ï¼š mathjax, katex
# Support Math Formulas render, options: mathjax, katex
math: mathjax

# å¼€å¯æ–‡ç« ç½®é¡¶ï¼Œæ•°å­—è¶Šå°è¶Šé å‰
# Sticky post set-top in home page and the smaller nubmer will more forward.
#weight: 1
# å…³é—­æ–‡ç« ç›®å½•åŠŸèƒ½
# Disable table of content
#toc: false


# åŸæ–‡é“¾æ¥
# Post's origin link URL
#link:
# å›¾ç‰‡é“¾æ¥ï¼Œç”¨åœ¨open graphå’Œtwitterå¡ç‰‡ä¸Š
# Image source link that will use in open graph and twitter card
#imgs:
# åœ¨é¦–é¡µå±•å¼€å†…å®¹
# Expand content on the home page
#expand: true
# å¤–éƒ¨é“¾æ¥åœ°å€ï¼Œè®¿é—®æ—¶ç›´æ¥è·³è½¬
# It's means that will redirecting to external links
#extlink:
# åœ¨å½“å‰é¡µé¢å…³é—­è¯„è®ºåŠŸèƒ½
# Disabled comment plugins in this post
#comment:
#  enable: false

# ç»å¯¹è®¿é—®è·¯å¾„
# Absolute link for visit
#url: "spring03.html"


# å¼€å¯å„ç§å›¾æ¸²æŸ“ï¼Œå¦‚æµç¨‹å›¾ã€æ—¶åºå›¾ã€ç±»å›¾ç­‰
# Enable chart render, such as: flow, sequence, classes etc
#mermaid: true
---

>ğŸ§’ spring03

æœ¬æ–‡ä¸»è¦ä»‹ç»springä¸­çš„é¢å‘åˆ‡é¢ç¼–ç¨‹AOPï¼Œå®ç°ä¸ä¾µå…¥æºä»£ç çš„æƒ…å†µä¸‹å¯¹ä»£ç è¿›è¡Œå¢å¼ºå¤„ç†ï¼Œä»å…¥é—¨åˆ°æœ€åçš„é…ç½®ä»¥åŠæ¡ˆä¾‹è¿›è¡Œè®²è§£

<!--more-->

## AOPç®€ä»‹

å‰é¢æˆ‘ä»¬åœ¨ä»‹ç»Springçš„æ—¶å€™è¯´è¿‡ï¼ŒSpringæœ‰ä¸¤ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µï¼Œä¸€ä¸ªæ˜¯`IOC/DI`ï¼Œä¸€ä¸ªæ˜¯`AOP`ã€‚

å‰é¢å·²ç»å¯¹`IOC/DI`è¿›è¡Œäº†ç³»ç»Ÿçš„å­¦ä¹ ï¼Œæ¥ä¸‹æ¥è¦å­¦ä¹ å®ƒçš„å¦ä¸€ä¸ªæ ¸å¿ƒå†…å®¹ï¼Œå°±æ˜¯**AOP**ã€‚

å¯¹äºAOP,æˆ‘ä»¬å‰é¢æè¿‡ä¸€å¥è¯æ˜¯:**AOPæ˜¯åœ¨ä¸æ”¹åŸæœ‰ä»£ç çš„å‰æä¸‹å¯¹å…¶è¿›è¡Œå¢å¼ºã€‚**

å¯¹äºä¸‹é¢çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸»è¦å°±æ˜¯å›´ç»•ç€è¿™ä¸€å¥è¯è¿›è¡Œå±•å¼€å­¦ä¹ ï¼Œä¸»è¦å­¦ä¹ ä¸¤æ–¹é¢å†…å®¹`AOPæ ¸å¿ƒæ¦‚å¿µ`,`AOPä½œç”¨`:

### ä»€ä¹ˆæ˜¯AOP?

* AOP(Aspect Oriented Programming)é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼ŒæŒ‡å¯¼å¼€å‘è€…å¦‚ä½•ç»„ç»‡ç¨‹åºç»“æ„ã€‚
  * OOP(Object Oriented Programming)é¢å‘å¯¹è±¡ç¼–ç¨‹

æˆ‘ä»¬éƒ½çŸ¥é“OOPæ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œé‚£ä¹ˆAOPä¹Ÿæ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œç¼–ç¨‹æ€æƒ³ä¸»è¦çš„å†…å®¹å°±æ˜¯æŒ‡å¯¼ç¨‹åºå‘˜è¯¥å¦‚ä½•ç¼–å†™ç¨‹åºï¼Œæ‰€ä»¥å®ƒä»¬ä¸¤ä¸ªæ˜¯ä¸åŒçš„`ç¼–ç¨‹èŒƒå¼`ã€‚

### AOPä½œç”¨

- ä½œç”¨:åœ¨ä¸æƒŠåŠ¨åŸå§‹è®¾è®¡çš„åŸºç¡€ä¸Šä¸ºå…¶è¿›è¡ŒåŠŸèƒ½å¢å¼ºï¼Œå‰é¢å’±ä»¬æœ‰æŠ€æœ¯å°±å¯ä»¥å®ç°è¿™æ ·çš„åŠŸèƒ½å³**ä»£ç†æ¨¡å¼**ã€‚

### AOPæ ¸å¿ƒæ¦‚å¿µ

ä¸ºäº†èƒ½æ›´å¥½çš„ç†è§£AOPçš„ç›¸å…³æ¦‚å¿µï¼Œæˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ªç¯å¢ƒï¼Œæ•´ä¸ªç¯å¢ƒçš„å†…å®¹æˆ‘ä»¬æš‚æ—¶å¯ä»¥ä¸ç”¨å…³æ³¨ï¼Œæœ€ä¸»è¦çš„ç±»ä¸º:`BookDaoImpl` 

```java
@Repository
public class BookDaoImpl implements BookDao {
    public void save() {
        //è®°å½•ç¨‹åºå½“å‰æ‰§è¡Œæ‰§è¡Œï¼ˆå¼€å§‹æ—¶é—´ï¼‰
        Long startTime = System.currentTimeMillis();
        //ä¸šåŠ¡æ‰§è¡Œä¸‡æ¬¡
        for (int i = 0;i<10000;i++) {
            System.out.println("book dao save ...");
        }
        //è®°å½•ç¨‹åºå½“å‰æ‰§è¡Œæ—¶é—´ï¼ˆç»“æŸæ—¶é—´ï¼‰
        Long endTime = System.currentTimeMillis();
        //è®¡ç®—æ—¶é—´å·®
        Long totalTime = endTime-startTime;
        //è¾“å‡ºä¿¡æ¯
        System.out.println("æ‰§è¡Œä¸‡æ¬¡æ¶ˆè€—æ—¶é—´ï¼š" + totalTime + "ms");
    }
    public void update(){
        System.out.println("book dao update ...");
    }
    public void delete(){
        System.out.println("book dao delete ...");
    }
    public void select(){
        System.out.println("book dao select ...");
    }
}
```

ä»£ç çš„å†…å®¹ç›¸ä¿¡å¤§å®¶éƒ½èƒ½å¤Ÿè¯»æ‡‚ï¼Œå¯¹äº`save`æ–¹æ³•ä¸­æœ‰è®¡ç®—ä¸‡æ¬¡æ‰§è¡Œæ¶ˆè€—çš„æ—¶é—´ã€‚

å½“åœ¨Appç±»ä¸­ä»å®¹å™¨ä¸­è·å–bookDaoå¯¹è±¡åï¼Œåˆ†åˆ«æ‰§è¡Œå…¶`save`,`delete`,`update`å’Œ`select`æ–¹æ³•åä¼šæœ‰å¦‚ä¸‹çš„æ‰“å°ç»“æœ:

![1630143927489](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640087.png)

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±åº”è¯¥æœ‰äº›ç–‘é—®?

* å¯¹äºè®¡ç®—ä¸‡æ¬¡æ‰§è¡Œæ¶ˆè€—çš„æ—¶é—´åªæœ‰saveæ–¹æ³•æœ‰ï¼Œä¸ºä»€ä¹ˆdeleteå’Œupdateæ–¹æ³•ä¹Ÿä¼šæœ‰å‘¢?
* deleteå’Œupdateæ–¹æ³•æœ‰ï¼Œé‚£ä»€ä¹ˆselectæ–¹æ³•ä¸ºä»€ä¹ˆåˆæ²¡æœ‰å‘¢?

è¿™ä¸ªæ¡ˆä¾‹ä¸­å…¶å®å°±ä½¿ç”¨äº†Springçš„AOPï¼Œåœ¨ä¸æƒŠåŠ¨(æ”¹åŠ¨)åŸæœ‰è®¾è®¡(ä»£ç )çš„å‰æä¸‹ï¼Œæƒ³ç»™è°æ·»åŠ åŠŸèƒ½å°±ç»™è°æ·»åŠ ã€‚è¿™ä¸ªä¹Ÿå°±æ˜¯Springçš„ç†å¿µï¼š

* æ— å…¥ä¾µå¼/æ— ä¾µå…¥å¼

è¯´äº†è¿™ä¹ˆå¤šï¼ŒSpringåˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢?

![1630144353462](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640089.png)

(1)å‰é¢ä¸€ç›´åœ¨å¼ºè°ƒï¼ŒSpringçš„AOPæ˜¯å¯¹ä¸€ä¸ªç±»çš„æ–¹æ³•åœ¨ä¸è¿›è¡Œä»»ä½•ä¿®æ”¹çš„å‰æä¸‹å®ç°å¢å¼ºã€‚å¯¹äºä¸Šé¢çš„æ¡ˆä¾‹ä¸­BookServiceImplä¸­æœ‰`save`,`update`,`delete`å’Œ`select`æ–¹æ³•,è¿™äº›æ–¹æ³•æˆ‘ä»¬ç»™èµ·äº†ä¸€ä¸ªåå­—å«**è¿æ¥ç‚¹**

(2)åœ¨BookServiceImplçš„å››ä¸ªæ–¹æ³•ä¸­ï¼Œ`update`å’Œ`delete`åªæœ‰æ‰“å°æ²¡æœ‰è®¡ç®—ä¸‡æ¬¡æ‰§è¡Œæ¶ˆè€—æ—¶é—´ï¼Œä½†æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™å·²ç»æœ‰è¯¥åŠŸèƒ½ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´`update`å’Œ`delete`æ–¹æ³•éƒ½å·²ç»è¢«å¢å¼ºï¼Œæ‰€ä»¥å¯¹äºéœ€è¦å¢å¼ºçš„æ–¹æ³•æˆ‘ä»¬ç»™èµ·äº†ä¸€ä¸ªåå­—å«**åˆ‡å…¥ç‚¹**

(3)æ‰§è¡ŒBookServiceImplçš„updateå’Œdeleteæ–¹æ³•çš„æ—¶å€™éƒ½è¢«æ·»åŠ äº†ä¸€ä¸ªè®¡ç®—ä¸‡æ¬¡æ‰§è¡Œæ¶ˆè€—æ—¶é—´çš„åŠŸèƒ½ï¼Œå°†è¿™ä¸ªåŠŸèƒ½æŠ½å–åˆ°ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å­˜æ”¾å…±æ€§åŠŸèƒ½çš„æ–¹æ³•ï¼Œæˆ‘ä»¬ç»™èµ·äº†ä¸ªåå­—å«**é€šçŸ¥**

(4)é€šçŸ¥æ˜¯è¦å¢å¼ºçš„å†…å®¹ï¼Œä¼šæœ‰å¤šä¸ªï¼Œåˆ‡å…¥ç‚¹æ˜¯éœ€è¦è¢«å¢å¼ºçš„æ–¹æ³•ï¼Œä¹Ÿä¼šæœ‰å¤šä¸ªï¼Œé‚£å“ªä¸ªåˆ‡å…¥ç‚¹éœ€è¦æ·»åŠ å“ªä¸ªé€šçŸ¥ï¼Œå°±éœ€è¦æå‰å°†å®ƒä»¬ä¹‹é—´çš„å…³ç³»æè¿°æ¸…æ¥šï¼Œé‚£ä¹ˆå¯¹äºé€šçŸ¥å’Œåˆ‡å…¥ç‚¹ä¹‹é—´çš„å…³ç³»æè¿°ï¼Œæˆ‘ä»¬ç»™èµ·äº†ä¸ªåå­—å«**åˆ‡é¢**

(5)é€šçŸ¥æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•ä¸èƒ½ç‹¬ç«‹å­˜åœ¨éœ€è¦è¢«å†™åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œè¿™ä¸ªç±»æˆ‘ä»¬ä¹Ÿç»™èµ·äº†ä¸ªåå­—å«**é€šçŸ¥ç±»**

è‡³æ­¤AOPä¸­çš„æ ¸å¿ƒæ¦‚å¿µå°±å·²ç»ä»‹ç»å®Œäº†ï¼Œæ€»ç»“ä¸‹:

* è¿æ¥ç‚¹(JoinPoint)ï¼šç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä»»æ„ä½ç½®ï¼Œç²’åº¦ä¸ºæ‰§è¡Œæ–¹æ³•ã€æŠ›å‡ºå¼‚å¸¸ã€è®¾ç½®å˜é‡ç­‰
  * åœ¨SpringAOPä¸­ï¼Œç†è§£ä¸ºæ–¹æ³•çš„æ‰§è¡Œ
* åˆ‡å…¥ç‚¹(Pointcut):**åŒ¹é…**è¿æ¥ç‚¹çš„å¼å­
  * åœ¨SpringAOPä¸­ï¼Œä¸€ä¸ªåˆ‡å…¥ç‚¹å¯ä»¥æè¿°ä¸€ä¸ªå…·ä½“æ–¹æ³•ï¼Œä¹Ÿå¯ä¹ŸåŒ¹é…å¤šä¸ªæ–¹æ³•
    * ä¸€ä¸ªå…·ä½“çš„æ–¹æ³•:å¦‚com.itheima.daoåŒ…ä¸‹çš„BookDaoæ¥å£ä¸­çš„æ— å½¢å‚æ— è¿”å›å€¼çš„saveæ–¹æ³•
    * åŒ¹é…å¤šä¸ªæ–¹æ³•:æ‰€æœ‰çš„saveæ–¹æ³•ï¼Œæ‰€æœ‰çš„getå¼€å¤´çš„æ–¹æ³•ï¼Œæ‰€æœ‰ä»¥Daoç»“å°¾çš„æ¥å£ä¸­çš„ä»»æ„æ–¹æ³•ï¼Œæ‰€æœ‰å¸¦æœ‰ä¸€ä¸ªå‚æ•°çš„æ–¹æ³•
  * **è¿æ¥ç‚¹èŒƒå›´è¦æ¯”åˆ‡å…¥ç‚¹èŒƒå›´å¤§**ï¼Œæ˜¯åˆ‡å…¥ç‚¹çš„æ–¹æ³•ä¹Ÿä¸€å®šæ˜¯è¿æ¥ç‚¹ï¼Œä½†æ˜¯æ˜¯è¿æ¥ç‚¹çš„æ–¹æ³•å°±ä¸ä¸€å®šè¦è¢«å¢å¼ºï¼Œæ‰€ä»¥å¯èƒ½ä¸æ˜¯åˆ‡å…¥ç‚¹ã€‚
* é€šçŸ¥(Advice):åœ¨åˆ‡å…¥ç‚¹å¤„æ‰§è¡Œçš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯å…±æ€§åŠŸèƒ½
  * åœ¨SpringAOPä¸­ï¼ŒåŠŸèƒ½æœ€ç»ˆä»¥æ–¹æ³•çš„å½¢å¼å‘ˆç°
* é€šçŸ¥ç±»ï¼šå®šä¹‰é€šçŸ¥çš„ç±»
* åˆ‡é¢(Aspect):æè¿°é€šçŸ¥ä¸åˆ‡å…¥ç‚¹çš„å¯¹åº”å…³ç³»ã€‚

**å°ç»“**

è¿™ä¸€èŠ‚ä¸­ä¸»è¦è®²è§£äº†AOPçš„æ¦‚å¿µä¸ä½œç”¨ï¼Œä»¥åŠAOPä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå­¦å®Œä»¥åå¤§å®¶éœ€è¦èƒ½è¯´å‡º:

* ä»€ä¹ˆæ˜¯AOP?
* AOPçš„ä½œç”¨æ˜¯ä»€ä¹ˆ?
* AOPä¸­æ ¸å¿ƒæ¦‚å¿µåˆ†åˆ«æŒ‡çš„æ˜¯ä»€ä¹ˆ?
  * è¿æ¥ç‚¹ï¼šæ‰€æœ‰éœ€è¦å¢å¼ºçš„æ–¹æ³•
  * åˆ‡å…¥ç‚¹ï¼šæ‰€æœ‰å·²ç»è¢«å¢å¼ºçš„æ–¹æ³•
  * é€šçŸ¥ï¼šå¢å¼ºçš„å†…å®¹ï¼Œä¾‹å¦‚è®¡ç®—æ–¹æ³•æ‰§è¡Œè€—æ—¶
  * é€šçŸ¥ç±»ï¼šå­˜æ”¾é€šçŸ¥çš„ç±»
  * åˆ‡é¢ï¼šé€šçŸ¥å’Œåˆ‡å…¥ç‚¹çš„åŒ¹é…å…³ç³»

## AOPå…¥é—¨æ¡ˆä¾‹

### éœ€æ±‚åˆ†æ

æ¡ˆä¾‹è®¾å®šï¼šæµ‹ç®—æ¥å£æ‰§è¡Œæ•ˆç‡ï¼Œä½†æ˜¯è¿™ä¸ªæ¡ˆä¾‹ç¨å¾®å¤æ‚äº†ç‚¹ï¼Œæˆ‘ä»¬å¯¹å…¶è¿›è¡Œç®€åŒ–ã€‚

ç®€åŒ–è®¾å®šï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰è¾“å‡ºå½“å‰ç³»ç»Ÿæ—¶é—´ã€‚

å¯¹äºSpringAOPçš„å¼€å‘æœ‰ä¸¤ç§æ–¹å¼ï¼ŒXML å’Œ **æ³¨è§£**ï¼Œæˆ‘ä»¬ä½¿ç”¨å“ªä¸ªå‘¢?

å› ä¸ºç°åœ¨æ³¨è§£ä½¿ç”¨çš„æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥æœ¬æ¬¡è¯¾ç¨‹å°±é‡‡ç”¨æ³¨è§£å®ŒæˆAOPçš„å¼€å‘ã€‚

æ€»ç»“éœ€æ±‚ä¸º:ä½¿ç”¨SpringAOPçš„æ³¨è§£æ–¹å¼å®Œæˆåœ¨æ–¹æ³•æ‰§è¡Œçš„å‰æ‰“å°å‡ºå½“å‰ç³»ç»Ÿæ—¶é—´ã€‚

> ç›¸å½“äºå¢å¼ºä»£ç ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå‰æ‰“å°ç³»ç»Ÿæ—¶é—´ï¼Œæ˜¾ç¤ºæ–¹æ³•æ‰§è¡Œæ—¶é—´

### æ€è·¯åˆ†æ

éœ€æ±‚æ˜ç¡®åï¼Œå…·ä½“è¯¥å¦‚ä½•å®ç°ï¼Œéƒ½æœ‰å“ªäº›æ­¥éª¤ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æä¸‹:

> 1.å¯¼å…¥åæ ‡(pom.xml)
>
> 2.åˆ¶ä½œè¿æ¥ç‚¹(åŸå§‹æ“ä½œï¼ŒDaoæ¥å£ä¸å®ç°ç±»)
>
> 3.åˆ¶ä½œå…±æ€§åŠŸèƒ½(é€šçŸ¥ç±»ä¸é€šçŸ¥)
>
> 4.å®šä¹‰åˆ‡å…¥ç‚¹
>
> 5.ç»‘å®šåˆ‡å…¥ç‚¹ä¸é€šçŸ¥å…³ç³»(åˆ‡é¢)

### ç¯å¢ƒå‡†å¤‡

* åˆ›å»ºä¸€ä¸ªMavené¡¹ç›®

* pom.xmlæ·»åŠ Springä¾èµ–

  ```xml
  <dependencies>
      <dependency>
          <groupId>org.springframework</groupId>
          <artifactId>spring-context</artifactId>
          <version>5.2.10.RELEASE</version>
      </dependency>
  </dependencies>
  ```

* æ·»åŠ BookDaoå’ŒBookDaoImplç±»

  ```java
  public interface BookDao {
      public void save();
      public void update();
  }
  
  @Repository
  public class BookDaoImpl implements BookDao {
  
      public void save() {
          //æ‰‹åŠ¨å®ç°æ‰“å°æ‰§è¡Œæ—¶é—´
          System.out.println(System.currentTimeMillis());
          System.out.println("book dao save ...");
      }
  
      public void update(){
          System.out.println("book dao update ...");
      }
  }
  ```

* åˆ›å»ºSpringçš„é…ç½®ç±»ï¼Œç”¨æ¥ä»£æ›¿springçš„é…ç½®æ–‡ä»¶

  ```java
  @Configuration
  @ComponentScan("com.itheima")
  public class SpringConfig {
  }
  ```

* ç¼–å†™Appè¿è¡Œç±»

  ```java
  public class App {
      public static void main(String[] args) {
          ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);
          BookDao bookDao = ctx.getBean(BookDao.class);
          bookDao.save();
      }
  }
  ```

æœ€ç»ˆåˆ›å»ºå¥½çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹:

![1630167092142](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640090.png)

**è¯´æ˜:**

* ç›®å‰æ‰“å°saveæ–¹æ³•çš„æ—¶å€™ï¼Œå› ä¸ºæ–¹æ³•ä¸­æœ‰æ‰“å°ç³»ç»Ÿæ—¶é—´ï¼Œæ‰€ä»¥è¿è¡Œçš„æ—¶å€™æ˜¯å¯ä»¥çœ‹åˆ°ç³»ç»Ÿæ—¶é—´
* å¯¹äºupdateæ–¹æ³•æ¥è¯´ï¼Œå°±æ²¡æœ‰è¯¥åŠŸèƒ½
* æˆ‘ä»¬è¦ä½¿ç”¨SpringAOPçš„æ–¹å¼åœ¨ä¸æ”¹å˜updateæ–¹æ³•çš„å‰æä¸‹è®©å…¶å…·æœ‰æ‰“å°ç³»ç»Ÿæ—¶é—´çš„åŠŸèƒ½ã€‚

### AOPå®ç°æ­¥éª¤

#### æ­¥éª¤1:æ·»åŠ ä¾èµ–

pom.xml

```xml
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
    <version>1.9.4</version>
</dependency>
```

![1630146885493](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640091.png)

* å› ä¸º`spring-context`ä¸­å·²ç»å¯¼å…¥äº†`spring-aop`,æ‰€ä»¥ä¸éœ€è¦å†å•ç‹¬å¯¼å…¥`spring-aop`
* å¯¼å…¥AspectJçš„jaråŒ…,AspectJæ˜¯AOPæ€æƒ³çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼ŒSpringæœ‰è‡ªå·±çš„AOPå®ç°ï¼Œä½†æ˜¯ç›¸æ¯”äºAspectJæ¥è¯´æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥é‡‡ç”¨Springæ•´åˆApsectJçš„æ–¹å¼è¿›è¡ŒAOPå¼€å‘ã€‚

#### æ­¥éª¤2:å®šä¹‰æ¥å£ä¸å®ç°ç±»

> ç¯å¢ƒå‡†å¤‡çš„æ—¶å€™ï¼ŒBookDaoImplå·²ç»å‡†å¤‡å¥½ï¼Œä¸éœ€è¦åšä»»ä½•ä¿®æ”¹

#### æ­¥éª¤3:å®šä¹‰é€šçŸ¥ç±»å’Œé€šçŸ¥

é€šçŸ¥å°±æ˜¯å°†å…±æ€§åŠŸèƒ½æŠ½å–å‡ºæ¥åå½¢æˆçš„æ–¹æ³•ï¼Œå…±æ€§åŠŸèƒ½æŒ‡çš„å°±æ˜¯å½“å‰ç³»ç»Ÿæ—¶é—´çš„æ‰“å°ã€‚

```java
public class MyAdvice {
    public void method(){
        System.out.println(System.currentTimeMillis());
    }
}
```

ç±»åå’Œæ–¹æ³•åæ²¡æœ‰è¦æ±‚ï¼Œå¯ä»¥ä»»æ„ã€‚

#### æ­¥éª¤4:å®šä¹‰åˆ‡å…¥ç‚¹

BookDaoImplä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯saveå’Œupdateï¼Œæˆ‘ä»¬è¦å¢å¼ºçš„æ˜¯updateæ–¹æ³•ï¼Œè¯¥å¦‚ä½•å®šä¹‰å‘¢?

```java
public class MyAdvice {
    //åˆ‡å…¥ç‚¹ä»£è¡¨å¢å¼ºå“ªäº›æ–¹æ³•
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    public void method(){
        System.out.println(System.currentTimeMillis());
    }
}
```

**è¯´æ˜:**

* åˆ‡å…¥ç‚¹å®šä¹‰**ä¾æ‰˜**ä¸€ä¸ªä¸å…·æœ‰å®é™…æ„ä¹‰çš„æ–¹æ³•è¿›è¡Œï¼Œå³æ— å‚æ•°ã€æ— è¿”å›å€¼ã€æ–¹æ³•ä½“æ— å®é™…é€»è¾‘ã€‚
* executionåŠåé¢ç¼–å†™çš„å†…å®¹ï¼Œåé¢ä¼šæœ‰ç« èŠ‚ä¸“é—¨å»å­¦ä¹ ã€‚

#### æ­¥éª¤5:åˆ¶ä½œåˆ‡é¢

åˆ‡é¢æ˜¯ç”¨æ¥æè¿°é€šçŸ¥å’Œåˆ‡å…¥ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œå¦‚ä½•è¿›è¡Œå…³ç³»çš„ç»‘å®š?

```java
public class MyAdvice {
    //åˆ‡å…¥ç‚¹
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    //åˆ‡é¢
    @Before("pt()")
    //é€šçŸ¥
    public void method(){
        System.out.println(System.currentTimeMillis());
    }
}
```

ç»‘å®šåˆ‡å…¥ç‚¹ä¸é€šçŸ¥å…³ç³»ï¼Œå¹¶æŒ‡å®šé€šçŸ¥æ·»åŠ åˆ°åŸå§‹è¿æ¥ç‚¹çš„å…·ä½“æ‰§è¡Œ**ä½ç½®**

![1630148447689](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640092.png)

**è¯´æ˜:**@Beforeç¿»è¯‘è¿‡æ¥æ˜¯ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´é€šçŸ¥ä¼šåœ¨åˆ‡å…¥ç‚¹æ–¹æ³•æ‰§è¡Œ**ä¹‹å‰**æ‰§è¡Œï¼Œé™¤æ­¤ä¹‹å‰è¿˜æœ‰å…¶ä»–å››ç§ç±»å‹ï¼Œåé¢ä¼šè®²ã€‚

#### æ­¥éª¤6:å°†é€šçŸ¥ç±»é…ç»™å®¹å™¨å¹¶æ ‡è¯†å…¶ä¸ºåˆ‡é¢ç±»

```java
@Component
@Aspect//æ ‡è¯†å…¶ä¸ºé€šçŸ¥ç±»ï¼Œä¹‹åspringå°±ä¼šå¯¹åˆ‡å…¥ç‚¹æ–¹æ³•è¿›è¡Œå¢å¼º
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Before("pt()")
    public void method(){
        System.out.println(System.currentTimeMillis());
    }
}
```

#### æ­¥éª¤7:å¼€å¯æ³¨è§£æ ¼å¼AOPåŠŸèƒ½

```java
@Configuration
@ComponentScan("com.itheima")
@EnableAspectJAutoProxy//å¼€å¯AOPåŠŸèƒ½ï¼Œè®©springèƒ½å¤Ÿæ£€æµ‹åˆ°
public class SpringConfig {
}
```

#### æ­¥éª¤8:è¿è¡Œç¨‹åº

```java
public class App {
    public static void main(String[] args) {
        ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);
        BookDao bookDao = ctx.getBean(BookDao.class);
        //è°ƒç”¨è¿™ä¸ªæ–¹æ³•å‘ç°å·²ç»è¢«å¢å¼ºäº†
        bookDao.update();
    }
}
```

çœ‹åˆ°åœ¨æ‰§è¡Œupdateæ–¹æ³•ä¹‹å‰æ‰“å°äº†ç³»ç»Ÿæ—¶é—´æˆ³ï¼Œè¯´æ˜å¯¹åŸå§‹æ–¹æ³•è¿›è¡Œäº†å¢å¼ºï¼ŒAOPç¼–ç¨‹æˆåŠŸã€‚

![1630147945888](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640093.png)

### çŸ¥è¯†ç‚¹1ï¼š@EnableAspectJAutoProxy  

| åç§° | @EnableAspectJAutoProxy |
| ---- | ----------------------- |
| ç±»å‹ | é…ç½®ç±»æ³¨è§£              |
| ä½ç½® | é…ç½®ç±»å®šä¹‰ä¸Šæ–¹          |
| ä½œç”¨ | å¼€å¯æ³¨è§£æ ¼å¼AOPåŠŸèƒ½     |

### çŸ¥è¯†ç‚¹2ï¼š@Aspect

| åç§° | @Aspect               |
| ---- | --------------------- |
| ç±»å‹ | ç±»æ³¨è§£                |
| ä½ç½® | åˆ‡é¢ç±»å®šä¹‰ä¸Šæ–¹        |
| ä½œç”¨ | è®¾ç½®å½“å‰ç±»ä¸ºAOPåˆ‡é¢ç±» |

### çŸ¥è¯†ç‚¹3ï¼š@Pointcut   

| åç§° | @Pointcut                   |
| ---- | --------------------------- |
| ç±»å‹ | æ–¹æ³•æ³¨è§£                    |
| ä½ç½® | åˆ‡å…¥ç‚¹æ–¹æ³•å®šä¹‰ä¸Šæ–¹          |
| ä½œç”¨ | è®¾ç½®åˆ‡å…¥ç‚¹æ–¹æ³•              |
| å±æ€§ | valueï¼ˆé»˜è®¤ï¼‰ï¼šåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ |

### çŸ¥è¯†ç‚¹4ï¼š@Before

| åç§° | @Before                                                      |
| ---- | ------------------------------------------------------------ |
| ç±»å‹ | æ–¹æ³•æ³¨è§£                                                     |
| ä½ç½® | é€šçŸ¥æ–¹æ³•å®šä¹‰ä¸Šæ–¹                                             |
| ä½œç”¨ | è®¾ç½®å½“å‰é€šçŸ¥æ–¹æ³•ä¸åˆ‡å…¥ç‚¹ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼Œå½“å‰é€šçŸ¥æ–¹æ³•åœ¨åŸå§‹åˆ‡å…¥ç‚¹æ–¹æ³•å‰è¿è¡Œ |

### æ€»ç»“

ä¸ºäº†å°†éƒ¨åˆ†æ–¹æ³•å¢å¼ºï¼Œéœ€è¦ç»å†ä»¥ä¸‹å‡ æ­¥ï¼š

1. å®šä¹‰é€šçŸ¥å’Œé€šçŸ¥ç±»ï¼Œä¹Ÿå°±æ˜¯å¯¹ç›®æ ‡æ–¹æ³•å¦‚ä½•å¢å¼º
2. å®šä¹‰åˆ‡å…¥ç‚¹ï¼ŒæŒ‡å®šè¦å¢å¼ºå“ªäº›æ–¹æ³•ï¼Œå¹¶ä¸”ç¡®å®šå¢å¼ºçš„æ–¹å¼ï¼ˆå‰ï¼Œåï¼Œç¯ç»•ã€‚ã€‚ã€‚ï¼‰
3. è®©é€šçŸ¥ç±»è¢«springæ£€æµ‹åˆ°ï¼ˆ@Aspectæ³¨è§£ï¼‰ï¼Œå¹¶ä¸”æ‰“å¼€AOPæ³¨è§£å¼€å‘çš„å¼€å…³ï¼ˆ@EnableAspectJAutoProxy æ³¨è§£ï¼‰
4. æ‰§è¡ŒåŸå§‹æ–¹æ³•ï¼Œæ–¹æ³•å·²ç»è¢«å¢å¼º

## AOPå·¥ä½œæµç¨‹

AOPçš„å…¥é—¨æ¡ˆä¾‹å·²ç»å®Œæˆï¼Œå¯¹äºåˆšæ‰æ¡ˆä¾‹çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±å¾—æ¥åˆ†æåˆ†æï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬ä¸»è¦è®²è§£ä¸¤ä¸ªçŸ¥è¯†ç‚¹:`AOPå·¥ä½œæµç¨‹`å’Œ`AOPæ ¸å¿ƒæ¦‚å¿µ`ã€‚å…¶ä¸­æ ¸å¿ƒæ¦‚å¿µæ˜¯å¯¹å‰é¢æ ¸å¿ƒæ¦‚å¿µçš„è¡¥å……ã€‚

### AOPå·¥ä½œæµç¨‹

ç”±äºAOPæ˜¯åŸºäºSpringå®¹å™¨ç®¡ç†çš„beanåšçš„å¢å¼ºï¼Œæ‰€ä»¥æ•´ä¸ªå·¥ä½œè¿‡ç¨‹éœ€è¦ä»SpringåŠ è½½beanè¯´èµ·:

#### æµç¨‹1:Springå®¹å™¨å¯åŠ¨

* å®¹å™¨å¯åŠ¨å°±éœ€è¦å»åŠ è½½bean,å“ªäº›ç±»éœ€è¦è¢«åŠ è½½å‘¢?
* éœ€è¦è¢«å¢å¼ºçš„ç±»ï¼Œå¦‚:BookServiceImpl
* é€šçŸ¥ç±»ï¼Œå¦‚:MyAdvice
* æ³¨æ„æ­¤æ—¶beanå¯¹è±¡è¿˜æ²¡æœ‰åˆ›å»ºæˆåŠŸ

#### æµç¨‹2:è¯»å–æ‰€æœ‰åˆ‡é¢é…ç½®ä¸­çš„åˆ‡å…¥ç‚¹

![1630151682428](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640095.png)

* ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­æœ‰ä¸¤ä¸ªåˆ‡å…¥ç‚¹çš„é…ç½®ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ª`ptx()`å¹¶**æ²¡æœ‰è¢«ä½¿ç”¨**ï¼Œæ‰€ä»¥**ä¸ä¼šè¢«è¯»å–**ã€‚

#### æµç¨‹3:åˆå§‹åŒ–bean

åˆ¤å®šbeanå¯¹åº”çš„ç±»ä¸­çš„æ–¹æ³•æ˜¯å¦åŒ¹é…åˆ°ä»»æ„åˆ‡å…¥ç‚¹

* æ³¨æ„ç¬¬1æ­¥åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œbeanå¯¹è±¡è¿˜æ²¡æœ‰è¢«åˆ›å»ºæˆåŠŸã€‚

* è¦è¢«å®ä¾‹åŒ–beanå¯¹è±¡çš„ç±»ä¸­çš„æ–¹æ³•å’Œåˆ‡å…¥ç‚¹è¿›è¡ŒåŒ¹é…

  ![1630152538083](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640096.png)

  * åŒ¹é…å¤±è´¥ï¼Œåˆ›å»ºåŸå§‹å¯¹è±¡,å¦‚`UserDao`
    * åŒ¹é…å¤±è´¥è¯´æ˜ä¸éœ€è¦å¢å¼ºï¼Œç›´æ¥è°ƒç”¨åŸå§‹å¯¹è±¡çš„æ–¹æ³•å³å¯ã€‚
    
  * åŒ¹é…æˆåŠŸï¼Œåˆ›å»ºåŸå§‹å¯¹è±¡ï¼ˆ**ç›®æ ‡å¯¹è±¡**ï¼‰çš„**ä»£ç†**å¯¹è±¡,å¦‚:`BookDao`
    * åŒ¹é…æˆåŠŸè¯´æ˜éœ€è¦å¯¹å…¶è¿›è¡Œå¢å¼º
    
    * å¯¹å“ªä¸ªç±»åšå¢å¼ºï¼Œè¿™ä¸ªç±»å¯¹åº”çš„å¯¹è±¡å°±å«åšç›®æ ‡å¯¹è±¡
    
    * å› ä¸ºè¦å¯¹ç›®æ ‡å¯¹è±¡è¿›è¡ŒåŠŸèƒ½å¢å¼ºï¼Œè€Œé‡‡ç”¨çš„æŠ€æœ¯æ˜¯**åŠ¨æ€ä»£ç†**ï¼Œæ‰€ä»¥ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡
    
    * æœ€ç»ˆè¿è¡Œçš„æ˜¯ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šå¯¹åŸå§‹æ–¹æ³•è¿›è¡ŒåŠŸèƒ½å¢å¼º
    
      > ç›¸å½“äºåŒ…äº†ä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡çš„å£³å­ï¼Œåœ¨é‡Œé¢å¯¹æ–¹æ³•å¢å¼ºï¼Œå¯¹å¤–æš´éœ²çš„æ ·å­ä¸åŸå§‹æ–¹æ³•ä¸€æ ·

#### æµç¨‹4:è·å–beanæ‰§è¡Œæ–¹æ³•

* è·å–çš„beanæ˜¯åŸå§‹å¯¹è±¡æ—¶ï¼Œè°ƒç”¨æ–¹æ³•å¹¶æ‰§è¡Œï¼Œå®Œæˆæ“ä½œ
* è·å–çš„beanæ˜¯ä»£ç†å¯¹è±¡æ—¶ï¼Œæ ¹æ®ä»£ç†å¯¹è±¡çš„è¿è¡Œæ¨¡å¼è¿è¡ŒåŸå§‹æ–¹æ³•ä¸å¢å¼ºçš„å†…å®¹ï¼Œå®Œæˆæ“ä½œ

#### éªŒè¯å®¹å™¨ä¸­æ˜¯å¦ä¸ºä»£ç†å¯¹è±¡

ä¸ºäº†éªŒè¯IOCå®¹å™¨ä¸­åˆ›å»ºçš„å¯¹è±¡å’Œæˆ‘ä»¬åˆšæ‰æ‰€è¯´çš„ç»“è®ºæ˜¯å¦ä¸€è‡´ï¼Œé¦–å…ˆå…ˆæŠŠç»“è®ºç†å‡ºæ¥:

* å¦‚æœç›®æ ‡å¯¹è±¡ä¸­çš„æ–¹æ³•ä¼šè¢«å¢å¼ºï¼Œé‚£ä¹ˆå®¹å™¨ä¸­å°†å­˜å…¥çš„æ˜¯ç›®æ ‡å¯¹è±¡çš„**ä»£ç†å¯¹è±¡**
* å¦‚æœç›®æ ‡å¯¹è±¡ä¸­çš„æ–¹æ³•ä¸è¢«å¢å¼ºï¼Œé‚£ä¹ˆå®¹å™¨ä¸­å°†å­˜å…¥çš„æ˜¯ç›®æ ‡å¯¹è±¡æœ¬èº«ã€‚

##### éªŒè¯æ€è·¯

> 1.è¦æ‰§è¡Œçš„æ–¹æ³•ï¼Œä¸è¢«å®šä¹‰çš„åˆ‡å…¥ç‚¹åŒ…å«ï¼Œå³ä¸è¦å¢å¼ºï¼Œæ‰“å°å½“å‰ç±»çš„getClass()æ–¹æ³•
>
> 2.è¦æ‰§è¡Œçš„æ–¹æ³•ï¼Œè¢«å®šä¹‰çš„åˆ‡å…¥ç‚¹åŒ…å«ï¼Œå³è¦å¢å¼ºï¼Œæ‰“å°å‡ºå½“å‰ç±»çš„getClass()æ–¹æ³•
>
> 3.è§‚å¯Ÿä¸¤æ¬¡æ‰“å°çš„ç»“æœ

##### æ­¥éª¤1:ä¿®æ”¹Appç±»,è·å–ç±»çš„ç±»å‹

```java
public class App {
    public static void main(String[] args) {
        ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);
        BookDao bookDao = ctx.getBean(BookDao.class);
        System.out.println(bookDao);
        System.out.println(bookDao.getClass());
    }
}
```

##### æ­¥éª¤2:ä¿®æ”¹MyAdviceç±»ï¼Œä¸å¢å¼º

å› ä¸ºå®šä¹‰çš„åˆ‡å…¥ç‚¹ä¸­ï¼Œè¢«ä¿®æ”¹æˆ`update1`,æ‰€ä»¥BookDaoä¸­çš„updateæ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±ä¸ä¼šè¢«å¢å¼ºï¼Œä¹Ÿå°±æ˜¯åˆ‡å…¥ç‚¹æ²¡æœ‰åŒ¹é…åˆ°å¯¹åº”çš„è¿æ¥ç‚¹

æ‰€ä»¥å®¹å™¨ä¸­çš„å¯¹è±¡åº”è¯¥æ˜¯ç›®æ ‡å¯¹è±¡æœ¬èº«ã€‚

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update1())")
    private void pt(){}
    
    @Before("pt()")
    public void method(){
        System.out.println(System.currentTimeMillis());
    }
}
```

##### æ­¥éª¤3:è¿è¡Œç¨‹åº

![1630154495165](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640097.png)

##### æ­¥éª¤4:ä¿®æ”¹MyAdviceç±»ï¼Œå¢å¼º

å› ä¸ºå®šä¹‰çš„åˆ‡å…¥ç‚¹ä¸­ï¼Œè¢«ä¿®æ”¹æˆ`update`,æ‰€ä»¥BookDaoä¸­çš„updateæ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±ä¼šè¢«å¢å¼ºï¼Œä¹Ÿå°±æ˜¯åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒ¹é…åˆ°äº†å¯¹åº”çš„è¿æ¥ç‚¹

æ‰€ä»¥å®¹å™¨ä¸­çš„å¯¹è±¡åº”è¯¥æ˜¯ç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Before("pt()")
    public void method(){
        System.out.println(System.currentTimeMillis());
    }
}
```

##### æ­¥éª¤5:è¿è¡Œç¨‹åº

![1630154625564](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640098.png)

è‡³æ­¤å¯¹äºåˆšæ‰çš„ç»“è®ºï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†éªŒè¯ï¼Œè¿™å—å¤§å®¶éœ€è¦æ³¨æ„çš„æ˜¯:

ä¸èƒ½ç›´æ¥æ‰“å°å¯¹è±¡ï¼Œä»ä¸Šé¢ä¸¤æ¬¡ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œç›´æ¥æ‰“å°å¯¹è±¡èµ°çš„æ˜¯å¯¹è±¡çš„toStringæ–¹æ³•ï¼Œä¸ç®¡æ˜¯ä¸æ˜¯ä»£ç†å¯¹è±¡æ‰“å°çš„ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼ŒåŸå› æ˜¯å†…éƒ¨å¯¹toStringæ–¹æ³•è¿›è¡Œäº†é‡å†™ã€‚ä»£ç†å¯¹è±¡çš„å†…å®¹æ‰“å°å‡ºæ¥ä¸åŸå§‹å¯¹è±¡çš„å†…å®¹ä¸€è‡´

### AOPæ ¸å¿ƒæ¦‚å¿µ

åœ¨ä¸Šé¢ä»‹ç»AOPçš„å·¥ä½œæµç¨‹ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯:

* ç›®æ ‡å¯¹è±¡(Target)ï¼šåŸå§‹åŠŸèƒ½å»æ‰å…±æ€§åŠŸèƒ½å¯¹åº”çš„ç±»äº§ç”Ÿçš„å¯¹è±¡ï¼Œè¿™ç§å¯¹è±¡æ˜¯æ— æ³•ç›´æ¥å®Œæˆæœ€ç»ˆå·¥ä½œçš„
* ä»£ç†(Proxy)ï¼šç›®æ ‡å¯¹è±¡æ— æ³•ç›´æ¥å®Œæˆå·¥ä½œï¼Œéœ€è¦å¯¹å…¶è¿›è¡ŒåŠŸèƒ½å›å¡«ï¼Œé€šè¿‡åŸå§‹å¯¹è±¡çš„ä»£ç†å¯¹è±¡å®ç°

ä¸Šé¢è¿™ä¸¤ä¸ªæ¦‚å¿µæ¯”è¾ƒæŠ½è±¡ï¼Œç®€å•æ¥è¯´ï¼Œ

ç›®æ ‡å¯¹è±¡å°±æ˜¯è¦å¢å¼ºçš„ç±»[å¦‚:BookServiceImplç±»]å¯¹åº”çš„å¯¹è±¡ï¼Œä¹Ÿå«åŸå§‹å¯¹è±¡ï¼Œä¸èƒ½è¯´å®ƒä¸èƒ½è¿è¡Œï¼Œåªèƒ½è¯´å®ƒåœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­å¯¹äºè¦å¢å¼ºçš„å†…å®¹æ˜¯ç¼ºå¤±çš„ã€‚

SpringAOPæ˜¯åœ¨ä¸æ”¹å˜åŸæœ‰è®¾è®¡(ä»£ç )çš„å‰æä¸‹å¯¹å…¶è¿›è¡Œå¢å¼ºçš„ï¼Œå®ƒçš„åº•å±‚é‡‡ç”¨çš„æ˜¯ä»£ç†æ¨¡å¼å®ç°çš„ï¼Œæ‰€ä»¥è¦å¯¹åŸå§‹å¯¹è±¡è¿›è¡Œå¢å¼ºï¼Œå°±éœ€è¦å¯¹åŸå§‹å¯¹è±¡åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œåœ¨ä»£ç†å¯¹è±¡ä¸­çš„æ–¹æ³•æŠŠé€šçŸ¥[å¦‚:MyAdviceä¸­çš„methodæ–¹æ³•]å†…å®¹åŠ è¿›å»ï¼Œå°±å®ç°äº†å¢å¼º,è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ä»£ç†(Proxy)ã€‚

> ä½¿ç”¨åŠ¨æ€ä»£ç†å®ç°å¯¹ä»£ç çš„å¢å¼º

**å°ç»“**

é€šè¿‡è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŒæ¡çš„å†…å®¹æœ‰ï¼š

* èƒ½è¯´å‡ºAOPçš„å·¥ä½œæµç¨‹ï¼šä¸€æ—¦æŸä¸ªæ–¹æ³•è¢«å¢å¼ºï¼Œä¼šè°ƒç”¨å…¶ä»£ç†æ–¹æ³•ï¼Œåœ¨é‡Œé¢å®æ–½å¢å¼ºï¼Œå¯¹å¤–æš´éœ²çš„æ¥å£æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¢å¼ºè¿‡ç¨‹å¤–éƒ¨æ— æ„Ÿ
* AOPçš„æ ¸å¿ƒæ¦‚å¿µ
  * ç›®æ ‡å¯¹è±¡ã€è¿æ¥ç‚¹ã€åˆ‡å…¥ç‚¹
  * é€šçŸ¥ç±»ã€é€šçŸ¥
  * åˆ‡é¢
  * ä»£ç†
* SpringAOPçš„æœ¬è´¨æˆ–è€…å¯ä»¥è¯´åº•å±‚å®ç°æ˜¯é€šè¿‡**ä»£ç†æ¨¡å¼**ã€‚

## AOPé…ç½®ç®¡ç†

###  AOPåˆ‡å…¥ç‚¹è¡¨è¾¾å¼

å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œæœ‰æ¶‰åŠåˆ°å¦‚ä¸‹å†…å®¹:

![1630155937718](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640099.png)

å¯¹äºAOPä¸­åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬æ€»å…±ä¼šå­¦ä¹ ä¸‰ä¸ªå†…å®¹ï¼Œåˆ†åˆ«æ˜¯`è¯­æ³•æ ¼å¼`ã€`é€šé…ç¬¦`å’Œ`ä¹¦å†™æŠ€å·§`ã€‚

#### 4.1.1 è¯­æ³•æ ¼å¼

é¦–å…ˆæˆ‘ä»¬å…ˆè¦æ˜ç¡®ä¸¤ä¸ªæ¦‚å¿µ:

* åˆ‡å…¥ç‚¹:è¦è¿›è¡Œå¢å¼ºçš„æ–¹æ³•
* åˆ‡å…¥ç‚¹è¡¨è¾¾å¼:è¦è¿›è¡Œå¢å¼ºçš„æ–¹æ³•çš„æè¿°æ–¹å¼

å¯¹äºåˆ‡å…¥ç‚¹çš„æè¿°ï¼Œæˆ‘ä»¬å…¶å®æ˜¯æœ‰ä¸¤ä¸­æ–¹å¼çš„ï¼Œå…ˆæ¥çœ‹ä¸‹å‰é¢çš„ä¾‹å­

![1630156172790](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640100.png)

æè¿°æ–¹å¼ä¸€ï¼šæ‰§è¡Œcom.itheima.daoåŒ…ä¸‹çš„BookDaoæ¥å£ä¸­çš„æ— å‚æ•°updateæ–¹æ³•

```java
execution(void com.itheima.dao.BookDao.update())
```

æè¿°æ–¹å¼äºŒï¼šæ‰§è¡Œcom.itheima.dao.implåŒ…ä¸‹çš„BookDaoImplç±»ä¸­çš„æ— å‚æ•°updateæ–¹æ³•

```java
execution(void com.itheima.dao.impl.BookDaoImpl.update())
```

å› ä¸ºè°ƒç”¨æ¥å£æ–¹æ³•çš„æ—¶å€™æœ€ç»ˆè¿è¡Œçš„è¿˜æ˜¯å…¶å®ç°ç±»çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¸Šé¢**ä¸¤ç§æè¿°æ–¹å¼éƒ½æ˜¯å¯ä»¥**çš„ã€‚

å¯¹äºåˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„è¯­æ³•ä¸º:

* åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ ‡å‡†æ ¼å¼ï¼šåŠ¨ä½œå…³é”®å­—(è®¿é—®ä¿®é¥°ç¬¦  è¿”å›å€¼  åŒ…å.ç±»/æ¥å£å.æ–¹æ³•å(å‚æ•°) å¼‚å¸¸åï¼‰

å¯¹äºè¿™ä¸ªæ ¼å¼ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç¡¬è®°ï¼Œé€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œç†è§£å®ƒ:

```java
execution(public User com.itheima.service.UserService.findById(int))
```

* executionï¼šåŠ¨ä½œå…³é”®å­—ï¼Œæè¿°åˆ‡å…¥ç‚¹çš„è¡Œä¸ºåŠ¨ä½œï¼Œä¾‹å¦‚executionè¡¨ç¤ºæ‰§è¡Œåˆ°æŒ‡å®šåˆ‡å…¥ç‚¹
* public:è®¿é—®ä¿®é¥°ç¬¦,è¿˜å¯ä»¥æ˜¯publicï¼Œprivateç­‰ï¼Œå¯ä»¥çœç•¥
* Userï¼šè¿”å›å€¼ï¼Œå†™è¿”å›å€¼ç±»å‹
* com.itheima.serviceï¼šåŒ…åï¼Œå¤šçº§åŒ…ä½¿ç”¨ç‚¹è¿æ¥
* UserService:ç±»/æ¥å£åç§°
* findByIdï¼šæ–¹æ³•å
* int:å‚æ•°ï¼Œç›´æ¥å†™å‚æ•°çš„ç±»å‹ï¼Œå¤šä¸ªç±»å‹ç”¨é€—å·éš”å¼€
* å¼‚å¸¸åï¼šæ–¹æ³•å®šä¹‰ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸ï¼Œå¯ä»¥çœç•¥

åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å°±æ˜¯è¦æ‰¾åˆ°éœ€è¦å¢å¼ºçš„æ–¹æ³•ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯å¯¹ä¸€ä¸ªå…·ä½“æ–¹æ³•çš„æè¿°ï¼Œä½†æ˜¯æ–¹æ³•çš„å®šä¹‰ä¼šæœ‰å¾ˆå¤šï¼Œæ‰€ä»¥å¦‚æœæ¯ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œæƒ³æƒ³è¿™å—å°±ä¼šè§‰å¾—å°†æ¥ç¼–å†™èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæœ‰æ²¡æœ‰æ›´ç®€å•çš„æ–¹å¼å‘¢?

å°±éœ€è¦ç”¨åˆ°ä¸‹é¢æ‰€å­¦ä¹ çš„**é€šé…ç¬¦**ã€‚

> ä¸€æ—¦æŸä¸ªæ–¹æ³•åŒ¹é…åˆ°ä¸€ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±ä¼šè¢«å¢å¼º

#### 4.1.2 é€šé…ç¬¦

æˆ‘ä»¬ä½¿ç”¨é€šé…ç¬¦æè¿°åˆ‡å…¥ç‚¹ï¼Œä¸»è¦çš„ç›®çš„å°±æ˜¯ç®€åŒ–ä¹‹å‰çš„é…ç½®ï¼Œå…·ä½“éƒ½æœ‰å“ªäº›é€šé…ç¬¦å¯ä»¥ä½¿ç”¨?

* `*`:**å•ä¸ª**ç‹¬ç«‹çš„ä»»æ„ç¬¦å·ï¼Œå¯ä»¥ç‹¬ç«‹å‡ºç°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå‰ç¼€æˆ–è€…åç¼€çš„åŒ¹é…ç¬¦å‡ºç°

  ```java
  executionï¼ˆpublic * com.itheima.*.UserService.find*(*))
  ```

  åŒ¹é…com.itheimaåŒ…ä¸‹çš„ä»»æ„åŒ…ä¸­çš„UserServiceç±»æˆ–æ¥å£ä¸­æ‰€æœ‰findå¼€å¤´çš„å¸¦æœ‰ä¸€ä¸ªå‚æ•°çš„æ–¹æ³•

* `..`ï¼š**å¤šä¸ª**è¿ç»­çš„ä»»æ„ç¬¦å·ï¼Œå¯ä»¥ç‹¬ç«‹å‡ºç°ï¼Œå¸¸ç”¨äºç®€åŒ–åŒ…åä¸å‚æ•°çš„ä¹¦å†™

  ```java
  executionï¼ˆpublic User com..UserService.findById(..))
  ```

  åŒ¹é…comåŒ…ä¸‹çš„ä»»æ„åŒ…ä¸­çš„UserServiceç±»æˆ–æ¥å£ä¸­æ‰€æœ‰åç§°ä¸ºfindByIdçš„æ–¹æ³•

* `+`ï¼šä¸“ç”¨äºåŒ¹é…å­ç±»ç±»å‹

  ```java
  execution(* *..*Service+.*(..))
  ```

  è¿™ä¸ª**ä½¿ç”¨ç‡è¾ƒä½**ï¼Œæè¿°å­ç±»çš„ï¼Œå’±ä»¬åšJavaEEå¼€å‘ï¼Œç»§æ‰¿æœºä¼šå°±ä¸€æ¬¡ï¼Œä½¿ç”¨éƒ½å¾ˆæ…é‡ï¼Œæ‰€ä»¥å¾ˆå°‘ç”¨å®ƒã€‚*Service+ï¼Œè¡¨ç¤ºæ‰€æœ‰ä»¥Serviceç»“å°¾çš„æ¥å£çš„å­ç±»ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠæ¡ˆä¾‹ä¸­ä½¿ç”¨åˆ°çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ¥åˆ†æä¸‹:

![1630163744963](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640101.png)

```java
execution(void com.itheima.dao.BookDao.update())
åŒ¹é…æ¥å£ï¼Œèƒ½åŒ¹é…åˆ°
execution(void com.itheima.dao.impl.BookDaoImpl.update())
åŒ¹é…å®ç°ç±»ï¼Œèƒ½åŒ¹é…åˆ°
execution(* com.itheima.dao.impl.BookDaoImpl.update())
è¿”å›å€¼ä»»æ„ï¼Œèƒ½åŒ¹é…åˆ°
execution(* com.itheima.dao.impl.BookDaoImpl.update(*))
è¿”å›å€¼ä»»æ„ï¼Œä½†æ˜¯updateæ–¹æ³•å¿…é¡»è¦æœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ— æ³•åŒ¹é…ï¼Œè¦æƒ³åŒ¹é…éœ€è¦åœ¨updateæ¥å£å’Œå®ç°ç±»æ·»åŠ å‚æ•°
execution(void com.*.*.*.*.update())
è¿”å›å€¼ä¸ºvoid,comåŒ…ä¸‹çš„ä»»æ„åŒ…ä¸‰å±‚åŒ…ä¸‹çš„ä»»æ„ç±»çš„updateæ–¹æ³•ï¼ŒåŒ¹é…åˆ°çš„æ˜¯å®ç°ç±»ï¼Œèƒ½åŒ¹é…
execution(void com.*.*.*.update())
è¿”å›å€¼ä¸ºvoid,comåŒ…ä¸‹çš„ä»»æ„ä¸¤å±‚åŒ…ä¸‹çš„ä»»æ„ç±»çš„updateæ–¹æ³•ï¼ŒåŒ¹é…åˆ°çš„æ˜¯æ¥å£ï¼Œèƒ½åŒ¹é…
execution(void *..update())
è¿”å›å€¼ä¸ºvoidï¼Œæ–¹æ³•åæ˜¯updateçš„ä»»æ„åŒ…ä¸‹çš„ä»»æ„ç±»ï¼Œèƒ½åŒ¹é…
execution(* *..*(..))
åŒ¹é…é¡¹ç›®ä¸­ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ï¼Œèƒ½åŒ¹é…ï¼Œä½†æ˜¯ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå½±å“èŒƒå›´å¹¿
execution(* *..u*(..))
åŒ¹é…é¡¹ç›®ä¸­ä»»æ„åŒ…ä»»æ„ç±»ä¸‹åªè¦ä»¥uå¼€å¤´çš„æ–¹æ³•ï¼Œupdateæ–¹æ³•èƒ½æ»¡è¶³ï¼Œèƒ½åŒ¹é…
execution(* *..*e(..))
åŒ¹é…é¡¹ç›®ä¸­ä»»æ„åŒ…ä»»æ„ç±»ä¸‹åªè¦ä»¥eç»“å°¾çš„æ–¹æ³•ï¼Œupdateå’Œsaveæ–¹æ³•èƒ½æ»¡è¶³ï¼Œèƒ½åŒ¹é…
execution(void com..*())
è¿”å›å€¼ä¸ºvoidï¼ŒcomåŒ…ä¸‹çš„ä»»æ„åŒ…ä»»æ„ç±»ä»»æ„æ–¹æ³•ï¼Œèƒ½åŒ¹é…ï¼Œ*ä»£è¡¨çš„æ˜¯æ–¹æ³•
execution(* com.itheima.*.*Service.find*(..))
å°†é¡¹ç›®ä¸­æ‰€æœ‰ä¸šåŠ¡å±‚æ–¹æ³•çš„ä»¥findå¼€å¤´çš„æ–¹æ³•åŒ¹é…
execution(* com.itheima.*.*Service.save*(..))
å°†é¡¹ç›®ä¸­æ‰€æœ‰ä¸šåŠ¡å±‚æ–¹æ³•çš„ä»¥saveå¼€å¤´çš„æ–¹æ³•åŒ¹é…
```

åé¢ä¸¤ç§æ›´ç¬¦åˆæˆ‘ä»¬å¹³å¸¸åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„ç¼–å†™è§„åˆ™

#### 4.1.3 ä¹¦å†™æŠ€å·§

å¯¹äºåˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„ç¼–å†™å…¶å®æ˜¯å¾ˆçµæ´»çš„ï¼Œé‚£ä¹ˆåœ¨ç¼–å†™çš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå¥½çš„æŠ€å·§è®©æˆ‘ä»¬ç”¨ç”¨:

- æ‰€æœ‰ä»£ç æŒ‰ç…§æ ‡å‡†è§„èŒƒå¼€å‘ï¼Œå¦åˆ™ä»¥ä¸‹æŠ€å·§å…¨éƒ¨å¤±æ•ˆ
- æè¿°åˆ‡å…¥ç‚¹**é€šå¸¸æè¿°æ¥å£**ï¼Œè€Œä¸æè¿°å®ç°ç±»,å¦‚æœæè¿°åˆ°å®ç°ç±»ï¼Œå°±å‡ºç°**ç´§è€¦åˆ**äº†
- è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦é’ˆå¯¹æ¥å£å¼€å‘å‡é‡‡ç”¨publicæè¿°ï¼ˆ**å¯çœç•¥è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦æè¿°**ï¼‰
- è¿”å›å€¼ç±»å‹å¯¹äºå¢åˆ æ”¹ç±»ä½¿ç”¨ç²¾å‡†ç±»å‹åŠ é€ŸåŒ¹é…ï¼Œå¯¹äºæŸ¥è¯¢ç±»ä½¿ç”¨\*é€šé…å¿«é€Ÿæè¿°
- **åŒ…å**ä¹¦å†™**å°½é‡ä¸ä½¿ç”¨..åŒ¹é…**ï¼Œæ•ˆç‡è¿‡ä½ï¼Œå¸¸ç”¨\*åšå•ä¸ªåŒ…æè¿°åŒ¹é…ï¼Œæˆ–ç²¾å‡†åŒ¹é…
- **æ¥å£å/ç±»å**ä¹¦å†™åç§°ä¸æ¨¡å—ç›¸å…³çš„**é‡‡ç”¨\*åŒ¹é…**ï¼Œä¾‹å¦‚UserServiceä¹¦å†™æˆ\*Serviceï¼Œç»‘å®šä¸šåŠ¡å±‚æ¥å£å
- **æ–¹æ³•å**ä¹¦å†™ä»¥**åŠ¨è¯**è¿›è¡Œ**ç²¾å‡†åŒ¹é…**ï¼Œåè¯é‡‡ç”¨*åŒ¹é…ï¼Œä¾‹å¦‚getByIdä¹¦å†™æˆgetBy*,selectAllä¹¦å†™æˆselectAll
- å‚æ•°è§„åˆ™è¾ƒä¸ºå¤æ‚ï¼Œæ ¹æ®ä¸šåŠ¡æ–¹æ³•çµæ´»è°ƒæ•´
- é€šå¸¸**ä¸ä½¿ç”¨å¼‚å¸¸**ä½œä¸º**åŒ¹é…**è§„åˆ™

### AOPé€šçŸ¥ç±»å‹

å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œæœ‰æ¶‰åŠåˆ°å¦‚ä¸‹å†…å®¹:

![1630164718080](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640102.png)

å®ƒæ‰€ä»£è¡¨çš„å«ä¹‰æ˜¯å°†`é€šçŸ¥`æ·»åŠ åˆ°`åˆ‡å…¥ç‚¹`æ–¹æ³•æ‰§è¡Œçš„**å‰é¢**ã€‚

é™¤äº†è¿™ä¸ªæ³¨è§£å¤–ï¼Œè¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ³¨è§£ï¼Œæ¢ä¸ªé—®é¢˜å°±æ˜¯é™¤äº†å¯ä»¥åœ¨å‰é¢åŠ ï¼Œèƒ½ä¸èƒ½åœ¨å…¶ä»–çš„åœ°æ–¹åŠ ?

#### ç±»å‹ä»‹ç»

æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹AOPé€šçŸ¥:

* AOPé€šçŸ¥æè¿°äº†æŠ½å–çš„å…±æ€§åŠŸèƒ½ï¼Œæ ¹æ®å…±æ€§åŠŸèƒ½æŠ½å–çš„**ä½ç½®ä¸åŒ**ï¼Œæœ€ç»ˆè¿è¡Œä»£ç æ—¶è¦å°†å…¶åŠ å…¥åˆ°åˆç†çš„ä½ç½®

é€šçŸ¥å…·ä½“è¦æ·»åŠ åˆ°åˆ‡å…¥ç‚¹çš„å“ªé‡Œ?

å…±æä¾›äº†5ç§é€šçŸ¥ç±»å‹:

- å‰ç½®é€šçŸ¥
- åç½®é€šçŸ¥
- **ç¯ç»•é€šçŸ¥(é‡ç‚¹)**
- è¿”å›åé€šçŸ¥(äº†è§£)
- æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥(äº†è§£)

ä¸ºäº†æ›´å¥½çš„ç†è§£è¿™å‡ ç§é€šçŸ¥ç±»å‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€å¼ å›¾

![1630166147697](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640103.png)

(1)å‰ç½®é€šçŸ¥ï¼Œè¿½åŠ åŠŸèƒ½åˆ°æ–¹æ³•æ‰§è¡Œå‰,ç±»ä¼¼äºåœ¨ä»£ç 1æˆ–è€…ä»£ç 2æ·»åŠ å†…å®¹

(2)åç½®é€šçŸ¥,è¿½åŠ åŠŸèƒ½åˆ°æ–¹æ³•æ‰§è¡Œå,ä¸ç®¡æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æœ‰æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼Œç±»ä¼¼äºåœ¨ä»£ç 5æ·»åŠ å†…å®¹

> ä¸‹é¢ä¸¤ç§é€šçŸ¥ï¼Œä¸€ä¸ªæ˜¯æ­£å¸¸æ‰§è¡Œæ‰é€šçŸ¥ï¼Œä¸€ä¸ªæ˜¯ä¸æ­£å¸¸æ‰§è¡Œæ‰é€šçŸ¥

(3)è¿”å›åé€šçŸ¥,è¿½åŠ åŠŸèƒ½åˆ°æ–¹æ³•æ‰§è¡Œåï¼Œåªæœ‰æ–¹æ³•**æ­£å¸¸æ‰§è¡Œç»“æŸ**åæ‰è¿›è¡Œ,ç±»ä¼¼äºåœ¨ä»£ç 3æ·»åŠ å†…å®¹ï¼Œå¦‚æœæ–¹æ³•æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œè¿”å›åé€šçŸ¥å°†ä¸ä¼šè¢«æ·»åŠ 

(4)æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥,è¿½åŠ åŠŸèƒ½åˆ°æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åï¼Œåªæœ‰æ–¹æ³•æ‰§è¡Œå‡ºå¼‚å¸¸æ‰è¿›è¡Œ,ç±»ä¼¼äºåœ¨ä»£ç 4æ·»åŠ å†…å®¹ï¼Œåªæœ‰æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åæ‰ä¼šè¢«æ·»åŠ 

(5)ç¯ç»•é€šçŸ¥,ç¯ç»•é€šçŸ¥åŠŸèƒ½æ¯”è¾ƒå¼ºå¤§ï¼Œå®ƒå¯ä»¥è¿½åŠ åŠŸèƒ½åˆ°æ–¹æ³•æ‰§è¡Œçš„å‰åï¼Œè¿™ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼ï¼Œå®ƒå¯ä»¥å®ç°å…¶ä»–å››ç§é€šçŸ¥ç±»å‹çš„åŠŸèƒ½ï¼Œå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ï¼Œéœ€è¦æˆ‘ä»¬å¾€ä¸‹å­¦ä¹ ã€‚

#### ç¯å¢ƒå‡†å¤‡

- åˆ›å»ºä¸€ä¸ªMavené¡¹ç›®

- pom.xmlæ·»åŠ Springä¾èµ–

  ```xml
  <dependencies>
      <dependency>
          <groupId>org.springframework</groupId>
          <artifactId>spring-context</artifactId>
          <version>5.2.10.RELEASE</version>
      </dependency>
      <dependency>
        <groupId>org.aspectj</groupId>
        <artifactId>aspectjweaver</artifactId>
        <version>1.9.4</version>
      </dependency>
  </dependencies>
  ```

- æ·»åŠ BookDaoå’ŒBookDaoImplç±»

  ```java
  public interface BookDao {
      public void update();
      public int select();
  }
  
  @Repository
  public class BookDaoImpl implements BookDao {
      public void update(){
          System.out.println("book dao update ...");
      }
      public int select() {
          System.out.println("book dao select is running ...");
          return 100;
      }
  }
  ```

- åˆ›å»ºSpringçš„é…ç½®ç±»

  ```java
  @Configuration
  @ComponentScan("com.itheima")
  @EnableAspectJAutoProxy
  public class SpringConfig {
  }
  ```

- åˆ›å»ºé€šçŸ¥ç±»

  ```java
  @Component
  @Aspect
  public class MyAdvice {
      @Pointcut("execution(void com.itheima.dao.BookDao.update())")
      private void pt(){}
  
      public void before() {
          System.out.println("before advice ...");
      }
  
      public void after() {
          System.out.println("after advice ...");
      }
  
      public void around(){
          System.out.println("around before advice ...");
          System.out.println("around after advice ...");
      }
  
      public void afterReturning() {
          System.out.println("afterReturning advice ...");
      }
      
      public void afterThrowing() {
          System.out.println("afterThrowing advice ...");
      }
  }
  ```

- ç¼–å†™Appè¿è¡Œç±»

  ```java
  public class App {
      public static void main(String[] args) {
          ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);
          BookDao bookDao = ctx.getBean(BookDao.class);
          bookDao.update();
      }
  }
  ```

æœ€ç»ˆåˆ›å»ºå¥½çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹:

![1630167385146](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640104.png)

#### é€šçŸ¥ç±»å‹çš„ä½¿ç”¨

##### å‰ç½®é€šçŸ¥

ä¿®æ”¹MyAdvice,åœ¨beforeæ–¹æ³•ä¸Šæ·»åŠ `@Beforeæ³¨è§£`

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    //åŠ ä¸Šé€šçŸ¥ä¸åˆ‡å…¥ç‚¹ä¹‹é—´çš„åŒ¹é…å…³ç³»
    @Before("pt()")
    //æ­¤å¤„ä¹Ÿå¯ä»¥å†™æˆ @Before("MyAdvice.pt()"),ä¸å»ºè®®
    public void before() {
        System.out.println("before advice ...");
    }
}
```

![1630167805723](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640105.png)

##### åç½®é€šçŸ¥

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Before("pt()")
    public void before() {
        System.out.println("before advice ...");
    }
    @After("pt()")
    public void after() {
        System.out.println("after advice ...");
    }
}
```

![1630167887131](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640106.png)

##### ç¯ç»•é€šçŸ¥

###### åŸºæœ¬ä½¿ç”¨

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Around("pt()")
    public void around(){
        System.out.println("around before advice ...");
        System.out.println("around after advice ...");
    }
}
```

![1630167969051](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640107.png)

è¿è¡Œç»“æœä¸­ï¼Œé€šçŸ¥çš„å†…å®¹æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯åŸå§‹æ–¹æ³•çš„å†…å®¹å´**æ²¡æœ‰è¢«æ‰§è¡Œ**ã€‚

å› ä¸ºç¯ç»•é€šçŸ¥éœ€è¦åœ¨åŸå§‹æ–¹æ³•çš„å‰åè¿›è¡Œå¢å¼ºï¼Œæ‰€ä»¥ç¯ç»•é€šçŸ¥å°±å¿…é¡»è¦èƒ½å¯¹åŸå§‹æ“ä½œè¿›è¡Œè°ƒç”¨ï¼Œå…·ä½“å¦‚ä½•å®ç°?

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Around("pt()")
    public void around(ProceedingJoinPoint pjp) throws Throwable{
        System.out.println("around before advice ...");
        //è¡¨ç¤ºå¯¹åŸå§‹æ“ä½œçš„è°ƒç”¨ï¼Œå¦‚æœæœ‰è¿”å›å€¼çš„è¯ï¼Œè¿˜éœ€è¦è¿”å›æ‰§è¡Œç»“æœ
        pjp.proceed();
        System.out.println("around after advice ...");
    }
}
```

**è¯´æ˜:**proceed()ä¸ºä»€ä¹ˆè¦æŠ›å‡ºå¼‚å¸¸?

åŸå› å¾ˆç®€å•ï¼Œçœ‹ä¸‹æºç å°±çŸ¥é“äº†ï¼Œé˜²æ­¢åŸå§‹æ–¹æ³•æ‰§è¡Œå‡ºé”™ï¼Œåœ¨ä»£ç†æ–¹æ³•ä¸­ä¸è¿›è¡Œå¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥æŠ›å‡º

![1630168248052](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640108.png)

å†æ¬¡è¿è¡Œï¼Œç¨‹åºå¯ä»¥çœ‹åˆ°åŸå§‹æ–¹æ³•å·²ç»è¢«æ‰§è¡Œäº†

![1630168293492](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640109.png)

###### æ³¨æ„äº‹é¡¹

(1)åŸå§‹æ–¹æ³•æœ‰è¿”å›å€¼çš„å¤„ç†

* ä¿®æ”¹MyAdvice,å¯¹BookDaoä¸­çš„selectæ–¹æ³•æ·»åŠ ç¯ç»•é€šçŸ¥ï¼Œ

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Pointcut("execution(int com.itheima.dao.BookDao.select())")
    private void pt2(){}
    
    @Around("pt2()")
    public void aroundSelect(ProceedingJoinPoint pjp) throws Throwable {
        System.out.println("around before advice ...");
        //è¡¨ç¤ºå¯¹åŸå§‹æ“ä½œçš„è°ƒç”¨
        pjp.proceed();
        System.out.println("around after advice ...");
    }
}
```

* ä¿®æ”¹Appç±»ï¼Œè°ƒç”¨selectæ–¹æ³•

```java
public class App {
    public static void main(String[] args) {
        ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);
        BookDao bookDao = ctx.getBean(BookDao.class);
        int num = bookDao.select();
        System.out.println(num);
    }
}
```

è¿è¡Œåä¼šæŠ¥é”™ï¼Œé”™è¯¯å†…å®¹ä¸º:

Exception in thread "main" org.springframework.aop.AopInvocationException: Null return value from advice does not match primitive return type for: public abstract int com.itheima.dao.BookDao.select()
	at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:226)
	at com.sun.proxy.$Proxy19.select(Unknown Source)
	at com.itheima.App.main(App.java:12)

é”™è¯¯å¤§æ¦‚çš„æ„æ€æ˜¯:`ç©ºçš„è¿”å›ä¸åŒ¹é…åŸå§‹æ–¹æ³•çš„intè¿”å›`

* voidå°±æ˜¯è¿”å›Null
* åŸå§‹æ–¹æ³•å°±æ˜¯BookDaoä¸‹çš„selectæ–¹æ³•

æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä½¿ç”¨ç¯ç»•é€šçŸ¥çš„è¯ï¼Œè¦**æ ¹æ®åŸå§‹æ–¹æ³•çš„è¿”å›å€¼æ¥è®¾ç½®ç¯ç»•é€šçŸ¥çš„è¿”å›å€¼**ï¼Œå…·ä½“è§£å†³æ–¹æ¡ˆä¸º:

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Pointcut("execution(int com.itheima.dao.BookDao.select())")
    private void pt2(){}
    
    //ç¯ç»•é€šçŸ¥çš„è¿”å›å€¼ä¸ºObject
    @Around("pt2()")
    public Object aroundSelect(ProceedingJoinPoint pjp) throws Throwable {
        System.out.println("around before advice ...");
        //è¡¨ç¤ºå¯¹åŸå§‹æ“ä½œçš„è°ƒç”¨
        Object ret = pjp.proceed();
        System.out.println("around after advice ...");
        return ret;
    }
}
```

**è¯´æ˜:**

â€‹	ä¸ºä»€ä¹ˆè¿”å›çš„æ˜¯Objectè€Œä¸æ˜¯intçš„ä¸»è¦åŸå› æ˜¯Objectç±»å‹æ›´é€šç”¨ã€‚

â€‹	åœ¨ç¯ç»•é€šçŸ¥ä¸­æ˜¯å¯ä»¥å¯¹åŸå§‹æ–¹æ³•è¿”å›å€¼å°±è¡Œä¿®æ”¹çš„ã€‚

> å®šä¹‰ä¸ºObjectçš„å…¼å®¹æ€§æ›´å¥½ï¼ŒåŸå§‹æ–¹æ³•æ²¡æœ‰è¿”å›å€¼å¯ä»¥è¿”å›nullï¼ŒåŸå§‹æ–¹æ³•æœ‰è¿”å›å€¼å¯ä»¥è¿”å›Objectç±»å‹çš„ç»“æœï¼Œå¤–å±‚æ¥æ”¶ä¹‹åè¿›è¡Œè½¬å‹

##### è¿”å›åé€šçŸ¥

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Pointcut("execution(int com.itheima.dao.BookDao.select())")
    private void pt2(){}
    
    @AfterReturning("pt2()")
    public void afterReturning() {
        System.out.println("afterReturning advice ...");
    }
}
```

![1630169124446](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640110.png)



**æ³¨æ„ï¼š**è¿”å›åé€šçŸ¥æ˜¯éœ€è¦åœ¨åŸå§‹æ–¹æ³•`select`æ­£å¸¸æ‰§è¡Œåæ‰ä¼šè¢«æ‰§è¡Œï¼Œå¦‚æœ`select()`æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿”å›åé€šçŸ¥æ˜¯ä¸ä¼šè¢«æ‰§è¡Œã€‚åç½®é€šçŸ¥æ˜¯ä¸ç®¡åŸå§‹æ–¹æ³•æœ‰æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸éƒ½ä¼šè¢«æ‰§è¡Œã€‚è¿™ä¸ªæ¡ˆä¾‹å¤§å®¶ä¸‹å»å¯ä»¥è‡ªå·±ç»ƒä¹ éªŒè¯ä¸‹ã€‚

##### å¼‚å¸¸åé€šçŸ¥

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(void com.itheima.dao.BookDao.update())")
    private void pt(){}
    
    @Pointcut("execution(int com.itheima.dao.BookDao.select())")
    private void pt2(){}
    
    @AfterReturning("pt2()")
    public void afterThrowing() {
        System.out.println("afterThrowing advice ...");
    }
}
```

![1630169357146](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640111.png)

**æ³¨æ„ï¼š**å¼‚å¸¸åé€šçŸ¥æ˜¯éœ€è¦åŸå§‹æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥åœ¨`select()`æ–¹æ³•ä¸­æ·»åŠ ä¸€è¡Œä»£ç `int i = 1/0`å³å¯ã€‚å¦‚æœæ²¡æœ‰æŠ›å¼‚å¸¸ï¼Œå¼‚å¸¸åé€šçŸ¥å°†ä¸ä¼šè¢«æ‰§è¡Œã€‚

å­¦ä¹ å®Œè¿™5ç§é€šçŸ¥ç±»å‹ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸‹ç¯ç»•é€šçŸ¥æ˜¯å¦‚ä½•å®ç°å…¶ä»–é€šçŸ¥ç±»å‹çš„åŠŸèƒ½çš„?

å› ä¸ºç¯ç»•é€šçŸ¥æ˜¯å¯ä»¥æ§åˆ¶åŸå§‹æ–¹æ³•æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå¢å¼ºçš„ä»£ç å†™åœ¨è°ƒç”¨åŸå§‹æ–¹æ³•çš„ä¸åŒä½ç½®å°±å¯ä»¥å®ç°ä¸åŒçš„é€šçŸ¥ç±»å‹çš„åŠŸèƒ½ï¼Œå¦‚:

![1630170090945](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640112.png)

##### é€šçŸ¥ç±»å‹æ€»ç»“

###### çŸ¥è¯†ç‚¹1ï¼š@After

| åç§° | @After                                                       |
| ---- | ------------------------------------------------------------ |
| ç±»å‹ | æ–¹æ³•æ³¨è§£                                                     |
| ä½ç½® | é€šçŸ¥æ–¹æ³•å®šä¹‰ä¸Šæ–¹                                             |
| ä½œç”¨ | è®¾ç½®å½“å‰é€šçŸ¥æ–¹æ³•ä¸åˆ‡å…¥ç‚¹ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼Œå½“å‰é€šçŸ¥æ–¹æ³•åœ¨åŸå§‹åˆ‡å…¥ç‚¹æ–¹æ³•åè¿è¡Œ |

###### çŸ¥è¯†ç‚¹2ï¼š@AfterReturning  

| åç§° | @AfterReturning                                              |
| ---- | ------------------------------------------------------------ |
| ç±»å‹ | æ–¹æ³•æ³¨è§£                                                     |
| ä½ç½® | é€šçŸ¥æ–¹æ³•å®šä¹‰ä¸Šæ–¹                                             |
| ä½œç”¨ | è®¾ç½®å½“å‰é€šçŸ¥æ–¹æ³•ä¸åˆ‡å…¥ç‚¹ä¹‹é—´ç»‘å®šå…³ç³»ï¼Œå½“å‰é€šçŸ¥æ–¹æ³•åœ¨åŸå§‹åˆ‡å…¥ç‚¹æ–¹æ³•æ­£å¸¸æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œ |

###### çŸ¥è¯†ç‚¹3ï¼š@AfterThrowing  

| åç§° | @AfterThrowing                                               |
| ---- | ------------------------------------------------------------ |
| ç±»å‹ | æ–¹æ³•æ³¨è§£                                                     |
| ä½ç½® | é€šçŸ¥æ–¹æ³•å®šä¹‰ä¸Šæ–¹                                             |
| ä½œç”¨ | è®¾ç½®å½“å‰é€šçŸ¥æ–¹æ³•ä¸åˆ‡å…¥ç‚¹ä¹‹é—´ç»‘å®šå…³ç³»ï¼Œå½“å‰é€šçŸ¥æ–¹æ³•åœ¨åŸå§‹åˆ‡å…¥ç‚¹æ–¹æ³•è¿è¡ŒæŠ›å‡ºå¼‚å¸¸åæ‰§è¡Œ |

###### çŸ¥è¯†ç‚¹4ï¼š@Around

| åç§° | @Around                                                      |
| ---- | ------------------------------------------------------------ |
| ç±»å‹ | æ–¹æ³•æ³¨è§£                                                     |
| ä½ç½® | é€šçŸ¥æ–¹æ³•å®šä¹‰ä¸Šæ–¹                                             |
| ä½œç”¨ | è®¾ç½®å½“å‰é€šçŸ¥æ–¹æ³•ä¸åˆ‡å…¥ç‚¹ä¹‹é—´çš„ç»‘å®šå…³ç³»ï¼Œå½“å‰é€šçŸ¥æ–¹æ³•åœ¨åŸå§‹åˆ‡å…¥ç‚¹æ–¹æ³•å‰åè¿è¡Œ |

**ç¯ç»•é€šçŸ¥æ³¨æ„äº‹é¡¹**

1. ç¯ç»•é€šçŸ¥å¿…é¡»ä¾èµ–å½¢å‚ProceedingJoinPointæ‰èƒ½å®ç°å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿›è€Œå®ç°åŸå§‹æ–¹æ³•è°ƒç”¨å‰ååŒæ—¶æ·»åŠ é€šçŸ¥
2. é€šçŸ¥ä¸­å¦‚æœæœªä½¿ç”¨ProceedingJoinPointå¯¹åŸå§‹æ–¹æ³•è¿›è¡Œè°ƒç”¨å°†è·³è¿‡åŸå§‹æ–¹æ³•çš„æ‰§è¡Œ
3. å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨å¯ä»¥ä¸æ¥æ”¶è¿”å›å€¼ï¼Œé€šçŸ¥æ–¹æ³•è®¾ç½®æˆvoidå³å¯ï¼Œå¦‚æœæ¥æ”¶è¿”å›å€¼ï¼Œæœ€å¥½è®¾å®šä¸ºObjectç±»å‹
4. åŸå§‹æ–¹æ³•çš„è¿”å›å€¼å¦‚æœæ˜¯voidç±»å‹ï¼Œé€šçŸ¥æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å¯ä»¥è®¾ç½®æˆvoid,ä¹Ÿå¯ä»¥è®¾ç½®æˆObject
5. ç”±äºæ— æ³•é¢„çŸ¥åŸå§‹æ–¹æ³•è¿è¡Œåæ˜¯å¦ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤ç¯ç»•é€šçŸ¥æ–¹æ³•å¿…é¡»è¦å¤„ç†Throwableå¼‚å¸¸

ä»‹ç»å®Œè¿™ä¹ˆå¤šç§é€šçŸ¥ç±»å‹ï¼Œå…·ä½“è¯¥é€‰å“ªä¸€ç§å‘¢?

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›æ¡ˆä¾‹åŠ æ·±ä¸‹å¯¹é€šçŸ¥ç±»å‹çš„å­¦ä¹ ã€‚

> è¡¥å……ä¸€ç‚¹ï¼Œé™¤äº†ç¯ç»•é€šçŸ¥çš„è¿”å›å€¼éœ€è¦è®¾ç½®ä¸º**Object**ï¼Œå…¶ä½™çš„é€šçŸ¥çš„è¿”å›å€¼è®¾ç½®ä¸ºvoidå³å¯

### ä¸šåŠ¡å±‚æ¥å£æ‰§è¡Œæ•ˆç‡

#### éœ€æ±‚åˆ†æ

è¿™ä¸ªéœ€æ±‚ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå‰é¢æˆ‘ä»¬åœ¨ä»‹ç»AOPçš„æ—¶å€™å·²ç»æ¼”ç¤ºè¿‡:

* éœ€æ±‚:ä»»æ„ä¸šåŠ¡å±‚æ¥å£æ‰§è¡Œå‡å¯æ˜¾ç¤ºå…¶æ‰§è¡Œæ•ˆç‡ï¼ˆæ‰§è¡Œæ—¶é•¿ï¼‰

è¿™ä¸ªæ¡ˆä¾‹çš„ç›®çš„æ˜¯æŸ¥çœ‹æ¯ä¸ªä¸šåŠ¡å±‚æ‰§è¡Œçš„æ—¶é—´ï¼Œè¿™æ ·å°±å¯ä»¥ç›‘æ§å‡ºå“ªä¸ªä¸šåŠ¡æ¯”è¾ƒè€—æ—¶ï¼Œå°†å…¶æŸ¥æ‰¾å‡ºæ¥æ–¹ä¾¿ä¼˜åŒ–ã€‚

å…·ä½“å®ç°çš„æ€è·¯:

(1) å¼€å§‹æ‰§è¡Œæ–¹æ³•ä¹‹å‰è®°å½•ä¸€ä¸ªæ—¶é—´

(2) æ‰§è¡Œæ–¹æ³•

(3) æ‰§è¡Œå®Œæ–¹æ³•ä¹‹åè®°å½•ä¸€ä¸ªæ—¶é—´

(4) ç”¨åä¸€ä¸ªæ—¶é—´å‡å»å‰ä¸€ä¸ªæ—¶é—´çš„å·®å€¼ï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ç»“æœã€‚

æ‰€ä»¥è¦åœ¨æ–¹æ³•æ‰§è¡Œçš„å‰åæ·»åŠ ä¸šåŠ¡ï¼Œç»è¿‡åˆ†ææˆ‘ä»¬å°†é‡‡ç”¨`ç¯ç»•é€šçŸ¥`ã€‚

**è¯´æ˜:**åŸå§‹æ–¹æ³•å¦‚æœåªæ‰§è¡Œä¸€æ¬¡ï¼Œæ—¶é—´å¤ªå¿«ï¼Œä¸¤ä¸ªæ—¶é—´å·®å¯èƒ½ä¸º0ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰§è¡Œä¸‡æ¬¡æ¥è®¡ç®—æ—¶é—´å·®ã€‚

#### ç¯å¢ƒå‡†å¤‡

- åˆ›å»ºä¸€ä¸ªMavené¡¹ç›®

- pom.xmlæ·»åŠ Springä¾èµ–

  ```xml
  <dependencies>
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>5.2.10.RELEASE</version>
      </dependency>
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-jdbc</artifactId>
        <version>5.2.10.RELEASE</version>
      </dependency>
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-test</artifactId>
        <version>5.2.10.RELEASE</version>
      </dependency>
      <dependency>
        <groupId>org.aspectj</groupId>
        <artifactId>aspectjweaver</artifactId>
        <version>1.9.4</version>
      </dependency>
      <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>5.1.47</version>
      </dependency>
      <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid</artifactId>
        <version>1.1.16</version>
      </dependency>
      <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>3.5.6</version>
      </dependency>
      <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis-spring</artifactId>
        <version>1.3.0</version>
      </dependency>
      <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.12</version>
        <scope>test</scope>
      </dependency>
    </dependencies>
  ```

- æ·»åŠ AccountServiceã€AccountServiceImplã€AccountDaoä¸Accountç±»

  ```java
  public interface AccountService {
      void save(Account account);
      void delete(Integer id);
      void update(Account account);
      List<Account> findAll();
      Account findById(Integer id);
  }
  
  @Service
  public class AccountServiceImpl implements AccountService {
  
      @Autowired
      private AccountDao accountDao;
  
      public void save(Account account) {
          accountDao.save(account);
      }
  
      public void update(Account account){
          accountDao.update(account);
      }
  
      public void delete(Integer id) {
          accountDao.delete(id);
      }
  
      public Account findById(Integer id) {
          return accountDao.findById(id);
      }
  
      public List<Account> findAll() {
          return accountDao.findAll();
      }
  }
  //----------------------------------
  public interface AccountDao {
  
      @Insert("insert into tbl_account(name,money)values(#{name},#{money})")
      void save(Account account);
  
      @Delete("delete from tbl_account where id = #{id} ")
      void delete(Integer id);
  
      @Update("update tbl_account set name = #{name} , money = #{money} where id = #{id} ")
      void update(Account account);
  
      @Select("select * from tbl_account")
      List<Account> findAll();
  
      @Select("select * from tbl_account where id = #{id} ")
      Account findById(Integer id);
  }
  //-----------------------------------
  public class Account implements Serializable {
  
      private Integer id;
      private String name;
      private Double money;
      //setter..getter..toStringæ–¹æ³•çœç•¥
  }
  ```

- resourcesä¸‹æä¾›ä¸€ä¸ªjdbc.properties

  ```properties
  jdbc.driver=com.mysql.jdbc.Driver
  jdbc.url=jdbc:mysql://localhost:3306/spring_db?useSSL=false
  jdbc.username=root
  jdbc.password=root
  ```

- åˆ›å»ºç›¸å…³é…ç½®ç±»

  ```java
  //Springé…ç½®ç±»:SpringConfig
  @Configuration
  @ComponentScan("com.itheima")
  @PropertySource("classpath:jdbc.properties")
  @Import({JdbcConfig.class,MybatisConfig.class})
  public class SpringConfig {
  }
  //JdbcConfigé…ç½®ç±»
  public class JdbcConfig {
      //é€šè¿‡æˆå‘˜å˜é‡çš„æ–¹å¼æ³¨å…¥åŸºæœ¬ç±»å‹çš„bean
      @Value("${jdbc.driver}")
      private String driver;
      @Value("${jdbc.url}")
      private String url;
      @Value("${jdbc.username}")
      private String userName;
      @Value("${jdbc.password}")
      private String password;
  
      @Bean
      public DataSource dataSource(){
          DruidDataSource ds = new DruidDataSource();
          ds.setDriverClassName(driver);
          ds.setUrl(url);
          ds.setUsername(userName);
          ds.setPassword(password);
          return ds;
      }
  }
  //MybatisConfigé…ç½®ç±»
  public class MybatisConfig {
  
      //é€šè¿‡å½¢å‚åœ¨æ–¹æ³•ä¸­æ³¨å…¥å¼•ç”¨ç±»å‹çš„bean
      @Bean
      public SqlSessionFactoryBean sqlSessionFactory(DataSource dataSource){
          SqlSessionFactoryBean ssfb = new SqlSessionFactoryBean();
          ssfb.setTypeAliasesPackage("com.itheima.domain");
          ssfb.setDataSource(dataSource);
          return ssfb;
      }
  
      @Bean
      public MapperScannerConfigurer mapperScannerConfigurer(){
          MapperScannerConfigurer msc = new MapperScannerConfigurer();
          msc.setBasePackage("com.itheima.dao");
          return msc;
      }
  }
  
  ```

- ç¼–å†™Springæ•´åˆJunitçš„æµ‹è¯•ç±»

  ```java
  @RunWith(SpringJUnit4ClassRunner.class)
  @ContextConfiguration(classes = SpringConfig.class)
  public class AccountServiceTestCase {
      @Autowired
      private AccountService accountService;
  
      @Test
      public void testFindById(){
          Account ac = accountService.findById(2);
      }
  
      @Test
      public void testFindAll(){
          List<Account> all = accountService.findAll();
      }
  
  }
  ```

æœ€ç»ˆåˆ›å»ºå¥½çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹:

![1630214631112](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640113.png)

#### åŠŸèƒ½å¼€å‘

##### æ­¥éª¤1:å¼€å¯SpringAOPçš„æ³¨è§£åŠŸèƒ½

åœ¨Springçš„ä¸»é…ç½®æ–‡ä»¶SpringConfigç±»ä¸­æ·»åŠ æ³¨è§£

```java
@EnableAspectJAutoProxy
```

##### æ­¥éª¤2:åˆ›å»ºAOPçš„é€šçŸ¥ç±»

* è¯¥ç±»è¦è¢«Springç®¡ç†ï¼Œéœ€è¦æ·»åŠ @Component

* è¦æ ‡è¯†è¯¥ç±»æ˜¯ä¸€ä¸ªAOPçš„åˆ‡é¢ç±»ï¼Œéœ€è¦æ·»åŠ **@Aspect**
* é…ç½®åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶æ·»åŠ **@Pointcut**

```java
@Component
@Aspect
public class ProjectAdvice {
    //é…ç½®ä¸šåŠ¡å±‚çš„æ‰€æœ‰æ–¹æ³•
    @Pointcut("execution(* com.itheima.service.*Service.*(..))")
    private void servicePt(){}
    
    public void runSpeed(){
        
    } 
}
```

##### æ­¥éª¤3:æ·»åŠ ç¯ç»•é€šçŸ¥

åœ¨runSpeed()æ–¹æ³•ä¸Šæ·»åŠ @Around

```java
@Component
@Aspect
public class ProjectAdvice {
    //é…ç½®ä¸šåŠ¡å±‚çš„æ‰€æœ‰æ–¹æ³•
    @Pointcut("execution(* com.itheima.service.*Service.*(..))")
    private void servicePt(){}
    //@Around("ProjectAdvice.servicePt()") å¯ä»¥ç®€å†™ä¸ºä¸‹é¢çš„æ–¹å¼
    @Around("servicePt()")
    public Object runSpeed(ProceedingJoinPoint pjp){
        Object ret = pjp.proceed();
        return ret;
    } 
}
```

**æ³¨æ„:**ç›®å‰å¹¶æ²¡æœ‰åšä»»ä½•å¢å¼º

##### æ­¥éª¤4:å®Œæˆæ ¸å¿ƒä¸šåŠ¡ï¼Œè®°å½•ä¸‡æ¬¡æ‰§è¡Œçš„æ—¶é—´

```java
@Component
@Aspect
public class ProjectAdvice {
    //é…ç½®ä¸šåŠ¡å±‚çš„æ‰€æœ‰æ–¹æ³•
    @Pointcut("execution(* com.itheima.service.*Service.*(..))")
    private void servicePt(){}
    //@Around("ProjectAdvice.servicePt()") å¯ä»¥ç®€å†™ä¸ºä¸‹é¢çš„æ–¹å¼
    @Around("servicePt()")
    public void runSpeed(ProceedingJoinPoint pjp){
        //å¼€å§‹æ—¶é—´
        long start = System.currentTimeMillis();
        //æ‰§è¡Œä¸‡æ¬¡çš„æ¶ˆè€—
        for (int i = 0; i < 10000; i++) {
           pjp.proceed();
        }
        //ç»“æŸæ—¶é—´
        long end = System.currentTimeMillis();
        System.out.println("ä¸šåŠ¡å±‚æ¥å£ä¸‡æ¬¡æ‰§è¡Œæ—¶é—´: "+(end-start)+"ms");
    } 
}
```

##### æ­¥éª¤5:è¿è¡Œå•å…ƒæµ‹è¯•ç±»

![1630215355776](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640114.png)

**æ³¨æ„:**å› ä¸ºç¨‹åºæ¯æ¬¡æ‰§è¡Œçš„æ—¶é•¿æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿è¡Œå¤šæ¬¡æœ€ç»ˆçš„ç»“æœæ˜¯ä¸ä¸€æ ·çš„ã€‚

##### æ­¥éª¤6:ç¨‹åºä¼˜åŒ–

ç›®å‰ç¨‹åºæ‰€é¢ä¸´çš„é—®é¢˜æ˜¯ï¼Œå¤šä¸ªæ–¹æ³•ä¸€èµ·æ‰§è¡Œæµ‹è¯•çš„æ—¶å€™ï¼Œæ§åˆ¶å°éƒ½æ‰“å°çš„æ˜¯:

`ä¸šåŠ¡å±‚æ¥å£ä¸‡æ¬¡æ‰§è¡Œæ—¶é—´:xxxms`

æˆ‘ä»¬**æ²¡æœ‰åŠæ³•åŒºåˆ†åˆ°åº•æ˜¯å“ªä¸ªæ¥å£çš„å“ªä¸ªæ–¹æ³•æ‰§è¡Œ**çš„å…·ä½“æ—¶é—´ï¼Œå…·ä½“å¦‚ä½•ä¼˜åŒ–?

> ä½¿ç”¨å½¢å‚`ProceedingJoinPoint`æä¾›çš„ä¸€äº›æ¥å£è·å–åˆ°å½“å‰è¢«ä»£ç†æ–¹æ³•çš„ä¸€äº›ä¿¡æ¯

```java
@Component
@Aspect
public class ProjectAdvice {
    //é…ç½®ä¸šåŠ¡å±‚çš„æ‰€æœ‰æ–¹æ³•
    @Pointcut("execution(* com.itheima.service.*Service.*(..))")
    private void servicePt(){}
    //@Around("ProjectAdvice.servicePt()") å¯ä»¥ç®€å†™ä¸ºä¸‹é¢çš„æ–¹å¼
    @Around("servicePt()")
    public void runSpeed(ProceedingJoinPoint pjp){
        //è·å–æ‰§è¡Œç­¾åä¿¡æ¯
        Signature signature = pjp.getSignature();
        //é€šè¿‡ç­¾åè·å–æ‰§è¡Œæ“ä½œåç§°(æ¥å£å)
        String className = signature.getDeclaringTypeName();
        //é€šè¿‡ç­¾åè·å–æ‰§è¡Œæ“ä½œåç§°(æ–¹æ³•å)
        String methodName = signature.getName();
        
        long start = System.currentTimeMillis();
        for (int i = 0; i < 10000; i++) {
           pjp.proceed();
        }
        long end = System.currentTimeMillis();
        System.out.println("ä¸‡æ¬¡æ‰§è¡Œï¼š"+ className+"."+methodName+"---->" +(end-start) + "ms");
    } 
}
```

##### æ­¥éª¤7:è¿è¡Œå•å…ƒæµ‹è¯•ç±»

![1630215743444](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640115.png)

**è¡¥å……è¯´æ˜**

å½“å‰æµ‹è¯•çš„æ¥å£æ‰§è¡Œæ•ˆç‡ä»…ä»…æ˜¯ä¸€ä¸ªç†è®ºå€¼ï¼Œå¹¶ä¸æ˜¯ä¸€æ¬¡å®Œæ•´çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

è¿™å—åªæ˜¯é€šè¿‡è¯¥æ¡ˆä¾‹æŠŠAOPçš„ä½¿ç”¨è¿›è¡Œäº†å­¦ä¹ ï¼Œå…·ä½“çš„å®é™…å€¼æ˜¯æœ‰å¾ˆå¤šå› ç´ å…±åŒå†³å®šçš„ã€‚

### AOPé€šçŸ¥è·å–æ•°æ®

ç›®å‰æˆ‘ä»¬å†™AOPä»…ä»…æ˜¯åœ¨åŸå§‹æ–¹æ³•å‰åè¿½åŠ ä¸€äº›æ“ä½œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦è¯´è¯´AOPä¸­æ•°æ®ç›¸å…³çš„å†…å®¹ï¼Œæˆ‘ä»¬å°†ä»`è·å–å‚æ•°`ã€`è·å–è¿”å›å€¼`å’Œ`è·å–å¼‚å¸¸`ä¸‰ä¸ªæ–¹é¢æ¥ç ”ç©¶åˆ‡å…¥ç‚¹çš„ç›¸å…³ä¿¡æ¯ã€‚

å‰é¢æˆ‘ä»¬ä»‹ç»é€šçŸ¥ç±»å‹çš„æ—¶å€™æ€»å…±è®²äº†äº”ç§ï¼Œé‚£ä¹ˆå¯¹äºè¿™äº”ç§ç±»å‹éƒ½ä¼šæœ‰å‚æ•°ï¼Œè¿”å›å€¼å’Œå¼‚å¸¸å—?

æˆ‘ä»¬å…ˆæ¥ä¸€ä¸ªä¸ªåˆ†æä¸‹:

* è·å–åˆ‡å…¥ç‚¹æ–¹æ³•çš„å‚æ•°ï¼Œæ‰€æœ‰çš„é€šçŸ¥ç±»å‹éƒ½å¯ä»¥è·å–å‚æ•°
  * JoinPointï¼šé€‚ç”¨äºå‰ç½®ã€åç½®ã€è¿”å›åã€æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥
  * ProceedingJoinPointï¼šé€‚ç”¨äºç¯ç»•é€šçŸ¥
* è·å–åˆ‡å…¥ç‚¹æ–¹æ³•è¿”å›å€¼ï¼Œå‰ç½®å’ŒæŠ›å‡ºå¼‚å¸¸åé€šçŸ¥æ˜¯æ²¡æœ‰è¿”å›å€¼ï¼Œåç½®é€šçŸ¥å¯æœ‰å¯æ— ï¼Œæ‰€ä»¥ä¸åšç ”ç©¶
  * è¿”å›åé€šçŸ¥
  * ç¯ç»•é€šçŸ¥
* è·å–åˆ‡å…¥ç‚¹æ–¹æ³•è¿è¡Œå¼‚å¸¸ä¿¡æ¯ï¼Œå‰ç½®å’Œè¿”å›åé€šçŸ¥æ˜¯ä¸ä¼šæœ‰ï¼Œåç½®é€šçŸ¥å¯æœ‰å¯æ— ï¼Œæ‰€ä»¥ä¸åšç ”ç©¶
  * æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥
  * ç¯ç»•é€šçŸ¥

#### ç¯å¢ƒå‡†å¤‡

- åˆ›å»ºä¸€ä¸ªMavené¡¹ç›®

- pom.xmlæ·»åŠ Springä¾èµ–

  ```xml
  <dependencies>
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>5.2.10.RELEASE</version>
      </dependency>
      <dependency>
        <groupId>org.aspectj</groupId>
        <artifactId>aspectjweaver</artifactId>
        <version>1.9.4</version>
      </dependency>
    </dependencies>
  ```

- æ·»åŠ BookDaoå’ŒBookDaoImplç±»

  ```java
  public interface BookDao {
      public String findName(int id);
  }
  @Repository
  public class BookDaoImpl implements BookDao {
  
      public String findName(int id) {
          System.out.println("id:"+id);
          return "itcast";
      }
  }
  ```

- åˆ›å»ºSpringçš„é…ç½®ç±»

  ```java
  @Configuration
  @ComponentScan("com.itheima")
  @EnableAspectJAutoProxy
  public class SpringConfig {
  }
  ```

- ç¼–å†™é€šçŸ¥ç±»

  ```java
  @Component
  @Aspect
  public class MyAdvice {
      @Pointcut("execution(* com.itheima.dao.BookDao.findName(..))")
      private void pt(){}
  
      @Before("pt()")
      public void before() {
          System.out.println("before advice ..." );
      }
  
      @After("pt()")
      public void after() {
          System.out.println("after advice ...");
      }
  
      @Around("pt()")
      public Object around() throws Throwable{
          Object ret = pjp.proceed();
          return ret;
      }
      @AfterReturning("pt()")
      public void afterReturning() {
          System.out.println("afterReturning advice ...");
      }
  
  
      @AfterThrowing("pt()")
      public void afterThrowing() {
          System.out.println("afterThrowing advice ...");
      }
  }
  ```

- ç¼–å†™Appè¿è¡Œç±»

  ```java
  public class App {
      public static void main(String[] args) {
          ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);
          BookDao bookDao = ctx.getBean(BookDao.class);
          String name = bookDao.findName(100);
          System.out.println(name);
      }
  }
  ```

æœ€ç»ˆåˆ›å»ºå¥½çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹:

![1630233154992](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640117.png)

#### è·å–å‚æ•°

##### éç¯ç»•é€šçŸ¥è·å–æ–¹å¼

åœ¨æ–¹æ³•ä¸Šæ·»åŠ JoinPoint,é€šè¿‡JoinPointæ¥è·å–å‚æ•°

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(* com.itheima.dao.BookDao.findName(..))")
    private void pt(){}

    @Before("pt()")
    public void before(JoinPoint jp) 
        Object[] args = jp.getArgs();
        System.out.println(Arrays.toString(args));
        System.out.println("before advice ..." );
    }
	//...å…¶ä»–çš„ç•¥
}
```

è¿è¡ŒAppç±»ï¼Œå¯ä»¥è·å–å¦‚ä¸‹å†…å®¹ï¼Œè¯´æ˜å‚æ•°100å·²ç»è¢«è·å–

![1630233291929](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640118.png)

**æ€è€ƒ:æ–¹æ³•çš„å‚æ•°åªæœ‰ä¸€ä¸ªï¼Œä¸ºä»€ä¹ˆè·å–çš„æ˜¯ä¸€ä¸ªæ•°ç»„?**

å› ä¸ºå‚æ•°çš„ä¸ªæ•°æ˜¯ä¸å›ºå®šçš„ï¼Œæ‰€ä»¥ä½¿ç”¨æ•°ç»„æ›´é€šé…äº›ã€‚

å¦‚æœå°†å‚æ•°æ”¹æˆä¸¤ä¸ªä¼šæ˜¯ä»€ä¹ˆæ•ˆæœå‘¢?

(1)ä¿®æ”¹BookDaoæ¥å£å’ŒBookDaoImplå®ç°ç±»

```java
public interface BookDao {
    public String findName(int id,String password);
}
@Repository
public class BookDaoImpl implements BookDao {

    public String findName(int id,String password) {
        System.out.println("id:"+id);
        return "itcast";
    }
}
```

(2)ä¿®æ”¹Appç±»ï¼Œè°ƒç”¨æ–¹æ³•ä¼ å…¥å¤šä¸ªå‚æ•°

```java
public class App {
    public static void main(String[] args) {
        ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);
        BookDao bookDao = ctx.getBean(BookDao.class);
        String name = bookDao.findName(100,"itheima");
        System.out.println(name);
    }
}
```

(3)è¿è¡ŒAppï¼ŒæŸ¥çœ‹ç»“æœ,è¯´æ˜ä¸¤ä¸ªå‚æ•°éƒ½å·²ç»è¢«è·å–åˆ°

![1630233548743](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640119.png)

**è¯´æ˜:**

ä½¿ç”¨JoinPointçš„æ–¹å¼è·å–å‚æ•°é€‚ç”¨äº`å‰ç½®`ã€`åç½®`ã€`è¿”å›å`ã€`æŠ›å‡ºå¼‚å¸¸å`é€šçŸ¥ã€‚å‰©ä¸‹çš„å¤§å®¶è‡ªè¡Œå»éªŒè¯ã€‚

##### ç¯ç»•é€šçŸ¥è·å–æ–¹å¼

ç¯ç»•é€šçŸ¥ä½¿ç”¨çš„æ˜¯ProceedingJoinPointï¼Œå› ä¸ºProceedingJoinPointæ˜¯JoinPointç±»çš„å­ç±»ï¼Œæ‰€ä»¥å¯¹äºProceedingJoinPointç±»ä¸­åº”è¯¥ä¹Ÿä¼šæœ‰å¯¹åº”çš„`getArgs()`æ–¹æ³•ï¼Œæˆ‘ä»¬å»éªŒè¯ä¸‹:

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(* com.itheima.dao.BookDao.findName(..))")
    private void pt(){}

    @Around("pt()")
    public Object around(ProceedingJoinPoint pjp)throws Throwable {
        Object[] args = pjp.getArgs();
        System.out.println(Arrays.toString(args));
        Object ret = pjp.proceed();
        return ret;
    }
	//å…¶ä»–çš„ç•¥
}
```

è¿è¡ŒAppåæŸ¥çœ‹è¿è¡Œç»“æœï¼Œè¯´æ˜ProceedingJoinPointä¹Ÿæ˜¯å¯ä»¥é€šè¿‡getArgs()è·å–å‚æ•°

![1630233974310](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640120.png)

**æ³¨æ„:**

* pjp.proceed()æ–¹æ³•æ˜¯æœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯:

  ![1630234756123](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640121.png)

  * è°ƒç”¨æ— å‚æ•°çš„proceedï¼Œå½“åŸå§‹æ–¹æ³•æœ‰å‚æ•°ï¼Œä¼šåœ¨è°ƒç”¨çš„è¿‡ç¨‹ä¸­è‡ªåŠ¨ä¼ å…¥å‚æ•°

  * æ‰€ä»¥è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„ä»»æ„ä¸€ä¸ªéƒ½å¯ä»¥å®ŒæˆåŠŸèƒ½

  * ä½†æ˜¯å½“éœ€è¦**ä¿®æ”¹åŸå§‹æ–¹æ³•çš„å‚æ•°**æ—¶ï¼Œå°±åªèƒ½é‡‡ç”¨å¸¦æœ‰å‚æ•°çš„æ–¹æ³•,å¦‚ä¸‹:

    ```java
    @Component
    @Aspect
    public class MyAdvice {
        @Pointcut("execution(* com.itheima.dao.BookDao.findName(..))")
        private void pt(){}
    
        @Around("pt()")
        public Object around(ProceedingJoinPoint pjp) throws Throwable{
            Object[] args = pjp.getArgs();
            System.out.println(Arrays.toString(args));
            args[0] = 666;
            Object ret = pjp.proceed(args);
            return ret;
        }
    	//å…¶ä»–çš„ç•¥
    }
    ```

    æœ‰äº†è¿™ä¸ªç‰¹æ€§åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç¯ç»•é€šçŸ¥ä¸­å¯¹åŸå§‹æ–¹æ³•çš„å‚æ•°è¿›è¡Œæ‹¦æˆªè¿‡æ»¤ï¼Œé¿å…ç”±äºå‚æ•°çš„é—®é¢˜å¯¼è‡´ç¨‹åºæ— æ³•æ­£ç¡®è¿è¡Œï¼Œä¿è¯ä»£ç çš„å¥å£®æ€§ã€‚

#### è·å–è¿”å›å€¼

å¯¹äºè¿”å›å€¼ï¼Œåªæœ‰è¿”å›å`AfterReturing`å’Œç¯ç»•`Around`è¿™ä¸¤ä¸ªé€šçŸ¥ç±»å‹å¯ä»¥è·å–ï¼Œå…·ä½“å¦‚ä½•è·å–?

##### ç¯ç»•é€šçŸ¥è·å–è¿”å›å€¼

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(* com.itheima.dao.BookDao.findName(..))")
    private void pt(){}

    @Around("pt()")
    public Object around(ProceedingJoinPoint pjp) throws Throwable{
        Object[] args = pjp.getArgs();
        System.out.println(Arrays.toString(args));
        args[0] = 666;
        Object ret = pjp.proceed(args);
        return ret;
    }
	//å…¶ä»–çš„ç•¥
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œ`ret`å°±æ˜¯æ–¹æ³•çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥ç›´æ¥è·å–ï¼Œä¸ä½†å¯ä»¥è·å–ï¼Œå¦‚æœéœ€è¦è¿˜å¯ä»¥è¿›è¡Œä¿®æ”¹ã€‚

##### è¿”å›åé€šçŸ¥è·å–è¿”å›å€¼

ç”±äºè¿™é‡Œæ²¡æœ‰è°ƒç”¨åŸå§‹æ–¹æ³•çš„ä»£ç ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡å˜é‡æ¥æ”¶ï¼Œé‚£å°±éœ€è¦åœ¨æ³¨è§£ä¸­æ ‡è¯†ä¸€ä¸‹ï¼Œå°†è¿”å›å€¼ç»‘å®šåˆ°ä¸€ä¸ªå½¢å‚ä¸­ï¼Œä»è€Œæ‹¿åˆ°æ–¹æ³•çš„è¿”å›å€¼

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(* com.itheima.dao.BookDao.findName(..))")
    private void pt(){}

    @AfterReturning(value = "pt()",returning = "ret")
    public void afterReturning(Object ret) {
        System.out.println("afterReturning advice ..."+ret);
    }
	//å…¶ä»–çš„ç•¥
}
```

**æ³¨æ„:**

(1)å‚æ•°åçš„é—®é¢˜

![1630237320870](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640122.png)

(2)afterReturningæ–¹æ³•å‚æ•°ç±»å‹çš„é—®é¢˜

å‚æ•°ç±»å‹å¯ä»¥å†™æˆStringï¼Œä½†æ˜¯ä¸ºäº†èƒ½åŒ¹é…æ›´å¤šçš„å‚æ•°ç±»å‹ï¼Œå»ºè®®å†™æˆObjectç±»å‹

(3)afterReturningæ–¹æ³•å‚æ•°çš„**é¡ºåº**é—®é¢˜

![1630237586682](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640123.png)

è¿è¡ŒAppåæŸ¥çœ‹è¿è¡Œç»“æœï¼Œè¯´æ˜è¿”å›å€¼å·²ç»è¢«è·å–åˆ°

![1630237372286](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640124.png)

#### è·å–å¼‚å¸¸

å¯¹äºè·å–æŠ›å‡ºçš„å¼‚å¸¸ï¼Œåªæœ‰æŠ›å‡ºå¼‚å¸¸å`AfterThrowing`å’Œç¯ç»•`Around`è¿™ä¸¤ä¸ªé€šçŸ¥ç±»å‹å¯ä»¥è·å–ï¼Œå…·ä½“å¦‚ä½•è·å–?

##### ç¯ç»•é€šçŸ¥è·å–å¼‚å¸¸

è¿™å—æ¯”è¾ƒç®€å•ï¼Œä»¥å‰æˆ‘ä»¬æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œç°åœ¨åªéœ€è¦å°†å¼‚å¸¸æ•è·ï¼Œå°±å¯ä»¥è·å–åˆ°åŸå§‹æ–¹æ³•çš„å¼‚å¸¸ä¿¡æ¯äº†

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(* com.itheima.dao.BookDao.findName(..))")
    private void pt(){}

    @Around("pt()")
    public Object around(ProceedingJoinPoint pjp){
        Object[] args = pjp.getArgs();
        System.out.println(Arrays.toString(args));
        args[0] = 666;
        Object ret = null;
        try{//å°è¯•æ•è·åŸå§‹æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸
            ret = pjp.proceed(args);
        }catch(Throwable throwable){
            t.printStackTrace();
        }
        //æ²¡æœ‰å‡ºç°å¼‚å¸¸å°±æ­£å¸¸è¿”å›
        return ret;
    }
	//å…¶ä»–çš„ç•¥
}
```

åœ¨catchæ–¹æ³•ä¸­å°±å¯ä»¥è·å–åˆ°å¼‚å¸¸ï¼Œè‡³äºè·å–åˆ°å¼‚å¸¸ä»¥åè¯¥å¦‚ä½•å¤„ç†ï¼Œè¿™ä¸ªå°±å’Œä½ çš„ä¸šåŠ¡éœ€æ±‚æœ‰å…³äº†ã€‚

##### æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥è·å–å¼‚å¸¸

ç”±äºè¿™é‡Œä¹Ÿæ²¡æœ‰è°ƒç”¨åŸå§‹æ–¹æ³•æ‰§è¡Œçš„ä»£ç ï¼Œä¸ºäº†è·å–åˆ°åŸå§‹æ–¹æ³•çš„æ‰§è¡Œå¼‚å¸¸ï¼Œä¸èƒ½ç›´æ¥æ·»åŠ try catchä»£ç å—ï¼Œæ‰€ä»¥å’Œè¿”å›æ—¶é€šçŸ¥è·å–è¿”å›å€¼ä¸€æ ·ï¼Œè¦å°†è¿”å›çš„å¼‚å¸¸æˆ–è€…å€¼é€šè¿‡æ³¨è§£ç»‘å®šåˆ°å‚æ•°ä¸­ï¼Œè¿”å›åé€šçŸ¥è·å–è¿”å›å€¼çš„ç±»å‹å°½å¯èƒ½çš„ä¸ºObjectï¼Œè¿™é‡Œè·å–å¼‚å¸¸çš„ç±»å‹å°½å¯èƒ½çš„ä¸ºExeception

```java
@Component
@Aspect
public class MyAdvice {
    @Pointcut("execution(* com.itheima.dao.BookDao.findName(..))")
    private void pt(){}

    @AfterThrowing(value = "pt()",throwing = "t")
    public void afterThrowing(Throwable t) {
        System.out.println("afterThrowing advice ..."+t);
    }
	//å…¶ä»–çš„ç•¥
}
```

å¦‚ä½•è®©åŸå§‹æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œæ–¹å¼æœ‰å¾ˆå¤šï¼Œ

```java
@Repository
public class BookDaoImpl implements BookDao {

    public String findName(int id,String password) {
        System.out.println("id:"+id);
        if(true){
            throw new NullPointerException();
        }
        return "itcast";
    }
}
```

**æ³¨æ„:**

![1630239939043](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640125.png)

è¿è¡ŒAppåï¼ŒæŸ¥çœ‹æ§åˆ¶å°ï¼Œå°±èƒ½çœ‹çš„å¼‚å¸¸ä¿¡æ¯è¢«æ‰“å°åˆ°æ§åˆ¶å°

![1630239997560](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640126.png)



è‡³æ­¤ï¼ŒAOPé€šçŸ¥å¦‚ä½•è·å–æ•°æ®å°±å·²ç»è®²è§£å®Œäº†ï¼Œæ•°æ®ä¸­åŒ…å«`å‚æ•°`ã€`è¿”å›å€¼`ã€`å¼‚å¸¸(äº†è§£)`ã€‚

è·å–å‚æ•°å¯é€šè¿‡ProceedingJoinPointçš„æ¥å£ï¼Œè·å–è¿”å›å€¼çš„æ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼Œç¯ç»•é€šçŸ¥æœ‰è°ƒç”¨åŸå§‹æ–¹æ³• çš„è¯­å¥ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡å˜é‡æ¥æ”¶å³å¯ï¼Œå‰©ä¸‹çš„æ–¹æ³•éœ€è¦è¿”å›å€¼éœ€è¦å°†è¿”å›å€¼é€šè¿‡æ³¨è§£çš„returningçš„å±æ€§å°†å…¶ç»‘å®šåˆ°å½¢å‚ä¸Šï¼Œè·å–å¼‚å¸¸çš„é€»è¾‘ä¸è·å–è¿”å›å€¼çš„é€»è¾‘æ˜¯ä¸€æ ·çš„

> æœ‰è°ƒç”¨åŸå§‹æ–¹æ³•çš„ä»£ç å°±ç›´æ¥è·å–ï¼Œæ²¡æœ‰è¿™ä¸ªä»£ç å°±é€šè¿‡æ³¨è§£ç»‘å®šåˆ°å½¢å‚ä¸­è·å–

### ç™¾åº¦ç½‘ç›˜å¯†ç æ•°æ®å…¼å®¹å¤„ç†

#### éœ€æ±‚åˆ†æ

éœ€æ±‚: å¯¹ç™¾åº¦ç½‘ç›˜åˆ†äº«é“¾æ¥è¾“å…¥å¯†ç æ—¶å°¾éƒ¨å¤šè¾“å…¥çš„ç©ºæ ¼åšå…¼å®¹å¤„ç†ã€‚

![1630240203033](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640127.png)

é—®é¢˜æè¿°:

* ç‚¹å‡»é“¾æ¥ï¼Œä¼šæç¤ºï¼Œè¯·è¾“å…¥æå–ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

  ![1630240528228](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640128.png)

* å½“æˆ‘ä»¬ä»åˆ«äººå‘ç»™æˆ‘ä»¬çš„å†…å®¹ä¸­å¤åˆ¶æå–ç çš„æ—¶å€™ï¼Œæœ‰æ—¶å€™ä¼šå¤šå¤åˆ¶åˆ°ä¸€äº›ç©ºæ ¼ï¼Œç›´æ¥ç²˜è´´åˆ°ç™¾åº¦çš„æå–ç è¾“å…¥æ¡†

* ä½†æ˜¯ç™¾åº¦é‚£è¾¹è®°å½•çš„æå–ç æ˜¯æ²¡æœ‰ç©ºæ ¼çš„

* è¿™ä¸ªæ—¶å€™å¦‚æœä¸åšå¤„ç†ï¼Œç›´æ¥å¯¹æ¯”çš„è¯ï¼Œå°±ä¼šå¼•å‘æå–ç ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ— æ³•è®¿é—®ç™¾åº¦ç›˜ä¸Šçš„å†…å®¹

* æ‰€ä»¥å¤šè¾“å…¥ä¸€ä¸ªç©ºæ ¼å¯èƒ½ä¼šå¯¼è‡´é¡¹ç›®çš„åŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚

* æ­¤æ—¶æˆ‘ä»¬å°±æƒ³èƒ½ä¸èƒ½å°†è¾“å…¥çš„å‚æ•°å…ˆå¸®ç”¨æˆ·å»æ‰ç©ºæ ¼å†æ“ä½œå‘¢?

ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œä¹‹å‰å¯¹æ‰€æœ‰çš„è¾“å…¥å‚æ•°è¿›è¡Œæ ¼å¼å¤„ç†â€”â€”trim()

* æ˜¯å¯¹æ‰€æœ‰çš„å‚æ•°éƒ½éœ€è¦å»é™¤ç©ºæ ¼ä¹ˆ?

ä¹Ÿæ²¡æœ‰å¿…è¦ï¼Œä¸€èˆ¬åªéœ€è¦é’ˆå¯¹å­—ç¬¦ä¸²å¤„ç†å³å¯ã€‚

* ä»¥åæ¶‰åŠåˆ°éœ€è¦å»é™¤å‰åç©ºæ ¼çš„ä¸šåŠ¡å¯èƒ½ä¼šæœ‰å¾ˆå¤šï¼Œè¿™ä¸ªå»ç©ºæ ¼çš„ä»£ç æ˜¯æ¯ä¸ªä¸šåŠ¡éƒ½å†™ä¹ˆ?

å¯ä»¥è€ƒè™‘ä½¿ç”¨AOPæ¥ç»Ÿä¸€å¤„ç†ã€‚

* AOPæœ‰äº”ç§é€šçŸ¥ç±»å‹ï¼Œè¯¥ä½¿ç”¨å“ªç§å‘¢?

æˆ‘ä»¬çš„éœ€æ±‚æ˜¯å°†åŸå§‹æ–¹æ³•çš„å‚æ•°å¤„ç†ååœ¨å‚ä¸åŸå§‹æ–¹æ³•çš„è°ƒç”¨ï¼Œèƒ½åšè¿™ä»¶äº‹çš„å°±åªæœ‰ç¯ç»•é€šçŸ¥ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸¤ä»¶äº‹:
â‘ ï¼šåœ¨ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œä¹‹å‰å¯¹æ‰€æœ‰çš„è¾“å…¥å‚æ•°è¿›è¡Œæ ¼å¼å¤„ç†â€”â€”trim()
â‘¡ï¼šä½¿ç”¨å¤„ç†åçš„å‚æ•°è°ƒç”¨åŸå§‹æ–¹æ³•â€”â€”ç¯ç»•é€šçŸ¥ä¸­å­˜åœ¨å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨

#### ç¯å¢ƒå‡†å¤‡

- åˆ›å»ºä¸€ä¸ªMavené¡¹ç›®

- pom.xmlæ·»åŠ Springä¾èµ–

  ```xml
  <dependencies>
      <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>5.2.10.RELEASE</version>
      </dependency>
      <dependency>
        <groupId>org.aspectj</groupId>
        <artifactId>aspectjweaver</artifactId>
        <version>1.9.4</version>
      </dependency>
    </dependencies>
  ```

- æ·»åŠ ResourcesServiceï¼ŒResourcesServiceImpl,ResourcesDaoå’ŒResourcesDaoImplç±»

  ```java
  public interface ResourcesDao {
      boolean readResources(String url, String password);
  }
  @Repository
  public class ResourcesDaoImpl implements ResourcesDao {
      public boolean readResources(String url, String password) {
          //æ¨¡æ‹Ÿæ ¡éªŒ
          return password.equals("root");
      }
  }
  public interface ResourcesService {
      public boolean openURL(String url ,String password);
  }
  @Service
  public class ResourcesServiceImpl implements ResourcesService {
      @Autowired
      private ResourcesDao resourcesDao;
  
      public boolean openURL(String url, String password) {
          return resourcesDao.readResources(url,password);
      }
  }
  
  ```

- åˆ›å»ºSpringçš„é…ç½®ç±»

  ```java
  @Configuration
  @ComponentScan("com.itheima")
  public class SpringConfig {
  }
  ```

- ç¼–å†™Appè¿è¡Œç±»

  ```java
  public class App {
      public static void main(String[] args) {
          ApplicationContext ctx = new AnnotationConfigApplicationContext(SpringConfig.class);
          ResourcesService resourcesService = ctx.getBean(ResourcesService.class);
          boolean flag = resourcesService.openURL("http://pan.baidu.com/haha", "root");
          System.out.println(flag);
      }
  }
  ```

æœ€ç»ˆåˆ›å»ºå¥½çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹:

![1630241681697](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640129.png)

ç°åœ¨é¡¹ç›®çš„æ•ˆæœæ˜¯ï¼Œå½“è¾“å…¥å¯†ç ä¸º"root"æ§åˆ¶å°æ‰“å°ä¸ºtrue,å¦‚æœå¯†ç æ”¹ä¸º"root  "æ§åˆ¶å°æ‰“å°çš„æ˜¯false

éœ€æ±‚æ˜¯ä½¿ç”¨AOPå°†å‚æ•°è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œä¸ç®¡è¾“å…¥çš„å¯†ç `root`å‰ååŒ…å«å¤šå°‘ä¸ªç©ºæ ¼ï¼Œæœ€ç»ˆæ§åˆ¶å°æ‰“å°çš„éƒ½æ˜¯trueã€‚

#### å…·ä½“å®ç°

##### æ­¥éª¤1:å¼€å¯SpringAOPçš„æ³¨è§£åŠŸèƒ½

```java
@Configuration
@ComponentScan("com.itheima")
@EnableAspectJAutoProxy
public class SpringConfig {
}
```

##### æ­¥éª¤2:ç¼–å†™é€šçŸ¥ç±»

```java
@Component
@Aspect
public class DataAdvice {
    @Pointcut("execution(boolean com.itheima.service.*Service.*(*,*))")
    private void servicePt(){}
    
}
```

##### æ­¥éª¤3:æ·»åŠ ç¯ç»•é€šçŸ¥

```java
@Component
@Aspect
public class DataAdvice {
    @Pointcut("execution(boolean com.itheima.service.*Service.*(*,*))")
    private void servicePt(){}
    
    @Around("DataAdvice.servicePt()")
    // @Around("servicePt()")è¿™ä¸¤ç§å†™æ³•éƒ½å¯¹
    public Object trimStr(ProceedingJoinPoint pjp) throws Throwable {
        Object ret = pjp.proceed();
        return ret;
    }
    
}
```

##### æ­¥éª¤4:å®Œæˆæ ¸å¿ƒä¸šåŠ¡ï¼Œå¤„ç†å‚æ•°ä¸­çš„ç©ºæ ¼

```java
@Component
@Aspect
public class DataAdvice {
    @Pointcut("execution(boolean com.itheima.service.*Service.*(*,*))")
    private void servicePt(){}
    
    @Around("DataAdvice.servicePt()")
    // @Around("servicePt()")è¿™ä¸¤ç§å†™æ³•éƒ½å¯¹
    public Object trimStr(ProceedingJoinPoint pjp) throws Throwable {
        //è·å–åŸå§‹æ–¹æ³•çš„å‚æ•°
        Object[] args = pjp.getArgs();
        for (int i = 0; i < args.length; i++) {
            //åˆ¤æ–­å‚æ•°æ˜¯ä¸æ˜¯å­—ç¬¦ä¸²
            if(args[i].getClass().equals(String.class)){
                args[i] = args[i].toString().trim();
            }
        }
        //å°†ä¿®æ”¹åçš„å‚æ•°ä¼ å…¥åˆ°åŸå§‹æ–¹æ³•çš„æ‰§è¡Œä¸­
        Object ret = pjp.proceed(args);
        return ret;
    }
    
}
```

##### æ­¥éª¤5:è¿è¡Œç¨‹åº

ä¸ç®¡å¯†ç `root`å‰åæ˜¯å¦åŠ ç©ºæ ¼ï¼Œæœ€ç»ˆæ§åˆ¶å°æ‰“å°çš„éƒ½æ˜¯true

##### æ­¥éª¤6:ä¼˜åŒ–æµ‹è¯•

ä¸ºäº†èƒ½æ›´å¥½çš„çœ‹å‡ºAOPå·²ç»ç”Ÿæ•ˆï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ResourcesImplç±»ï¼Œåœ¨æ–¹æ³•ä¸­å°†å¯†ç çš„é•¿åº¦è¿›è¡Œæ‰“å°

```java
@Repository
public class ResourcesDaoImpl implements ResourcesDao {
    public boolean readResources(String url, String password) {
        System.out.println(password.length());
        //æ¨¡æ‹Ÿæ ¡éªŒ
        return password.equals("root");
    }
}
```

å†æ¬¡è¿è¡ŒæˆåŠŸï¼Œå°±å¯ä»¥æ ¹æ®æœ€ç»ˆæ‰“å°çš„é•¿åº¦æ¥çœ‹çœ‹ï¼Œå­—ç¬¦ä¸²çš„ç©ºæ ¼æœ‰æ²¡æœ‰è¢«å»é™¤æ‰ã€‚

**æ³¨æ„ï¼š**

![1630242491831](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640130.png)

## AOPæ€»ç»“

AOPçš„çŸ¥è¯†å°±å·²ç»è®²è§£å®Œäº†ï¼Œæ¥ä¸‹æ¥å¯¹äºAOPçš„çŸ¥è¯†è¿›è¡Œä¸€ä¸ªæ€»ç»“:

### AOPçš„æ ¸å¿ƒæ¦‚å¿µ

* æ¦‚å¿µï¼šAOP(Aspect Oriented Programming)é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œä¸€ç§ç¼–ç¨‹èŒƒå¼
* ä½œç”¨ï¼šåœ¨ä¸æƒŠåŠ¨åŸå§‹è®¾è®¡çš„åŸºç¡€ä¸Šä¸ºæ–¹æ³•è¿›è¡ŒåŠŸèƒ½**å¢å¼º**
* æ ¸å¿ƒæ¦‚å¿µ
  * ä»£ç†ï¼ˆProxyï¼‰ï¼šSpringAOPçš„æ ¸å¿ƒæœ¬è´¨æ˜¯é‡‡ç”¨ä»£ç†æ¨¡å¼å®ç°çš„
  * è¿æ¥ç‚¹ï¼ˆJoinPointï¼‰ï¼šåœ¨SpringAOPä¸­ï¼Œç†è§£ä¸ºä»»æ„æ–¹æ³•çš„æ‰§è¡Œ
  * åˆ‡å…¥ç‚¹ï¼ˆPointcutï¼‰ï¼šåŒ¹é…è¿æ¥ç‚¹çš„å¼å­ï¼Œä¹Ÿæ˜¯å…·æœ‰å…±æ€§åŠŸèƒ½çš„æ–¹æ³•æè¿°
  * é€šçŸ¥ï¼ˆAdviceï¼‰ï¼šè‹¥å¹²ä¸ªæ–¹æ³•çš„å…±æ€§åŠŸèƒ½ï¼Œåœ¨åˆ‡å…¥ç‚¹å¤„æ‰§è¡Œï¼Œæœ€ç»ˆä½“ç°ä¸ºä¸€ä¸ªæ–¹æ³•
  * åˆ‡é¢ï¼ˆAspectï¼‰ï¼šæè¿°é€šçŸ¥ä¸åˆ‡å…¥ç‚¹çš„å¯¹åº”å…³ç³»
  * ç›®æ ‡å¯¹è±¡ï¼ˆTargetï¼‰ï¼šè¢«ä»£ç†çš„åŸå§‹å¯¹è±¡æˆä¸ºç›®æ ‡å¯¹è±¡

### åˆ‡å…¥ç‚¹è¡¨è¾¾å¼

* åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ ‡å‡†æ ¼å¼ï¼šåŠ¨ä½œå…³é”®å­—(è®¿é—®ä¿®é¥°ç¬¦  è¿”å›å€¼  åŒ…å.ç±»/æ¥å£å.æ–¹æ³•åï¼ˆå‚æ•°ï¼‰å¼‚å¸¸å)

  ```java
  execution(* com.itheima.service.*Service.*(..))
  ```

* åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æè¿°é€šé…ç¬¦ï¼š

  * ä½œç”¨ï¼šç”¨äºå¿«é€Ÿæè¿°ï¼ŒèŒƒå›´æè¿°
  * `*`ï¼šåŒ¹é…ä»»æ„ç¬¦å·ï¼ˆå¸¸ç”¨ï¼‰
  * `..` ï¼šåŒ¹é…å¤šä¸ªè¿ç»­çš„ä»»æ„ç¬¦å·ï¼ˆå¸¸ç”¨ï¼‰
  * `+`ï¼šåŒ¹é…å­ç±»ç±»å‹

* åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¹¦å†™æŠ€å·§

  1.æŒ‰æ ‡å‡†è§„èŒƒå¼€å‘
  2.æŸ¥è¯¢æ“ä½œçš„è¿”å›å€¼å»ºè®®ä½¿ç”¨\*åŒ¹é…
  3.å‡å°‘ä½¿ç”¨..çš„å½¢å¼æè¿°åŒ…
  4.å¯¹æ¥å£è¿›è¡Œæè¿°ï¼Œä½¿ç”¨\*è¡¨ç¤ºæ¨¡å—åï¼Œä¾‹å¦‚UserServiceçš„åŒ¹é…æè¿°ä¸º*Service
  5.æ–¹æ³•åä¹¦å†™ä¿ç•™åŠ¨è¯ï¼Œä¾‹å¦‚getï¼Œä½¿ç”¨\*è¡¨ç¤ºåè¯ï¼Œä¾‹å¦‚getByIdåŒ¹é…æè¿°ä¸ºgetBy\*
  6.å‚æ•°æ ¹æ®å®é™…æƒ…å†µçµæ´»è°ƒæ•´

### äº”ç§é€šçŸ¥ç±»å‹

- å‰ç½®é€šçŸ¥
- åç½®é€šçŸ¥
- ç¯ç»•é€šçŸ¥ï¼ˆ**é‡ç‚¹**ï¼‰
  - ç¯ç»•é€šçŸ¥ä¾èµ–å½¢å‚ProceedingJoinPointæ‰èƒ½å®ç°å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨
  - ç¯ç»•é€šçŸ¥å¯ä»¥éš”ç¦»åŸå§‹æ–¹æ³•çš„è°ƒç”¨æ‰§è¡Œ
  - ç¯ç»•é€šçŸ¥**è¿”å›å€¼**è®¾ç½®ä¸ºObjectç±»å‹
  - ç¯ç»•é€šçŸ¥ä¸­å¯ä»¥å¯¹åŸå§‹æ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­å‡ºç°çš„å¼‚å¸¸è¿›è¡Œå¤„ç†
- è¿”å›åé€šçŸ¥
- æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥

### é€šçŸ¥ä¸­è·å–å‚æ•°

- è·å–åˆ‡å…¥ç‚¹æ–¹æ³•çš„å‚æ•°ï¼Œæ‰€æœ‰çš„é€šçŸ¥ç±»å‹éƒ½å¯ä»¥è·å–å‚æ•°
  - JoinPointï¼šé€‚ç”¨äºå‰ç½®ã€åç½®ã€è¿”å›åã€æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥
  - ProceedingJoinPointï¼šé€‚ç”¨äºç¯ç»•é€šçŸ¥
- è·å–åˆ‡å…¥ç‚¹æ–¹æ³•è¿”å›å€¼ï¼Œå‰ç½®å’ŒæŠ›å‡ºå¼‚å¸¸åé€šçŸ¥æ˜¯æ²¡æœ‰è¿”å›å€¼ï¼Œåç½®é€šçŸ¥å¯æœ‰å¯æ— ï¼Œæ‰€ä»¥ä¸åšç ”ç©¶
  - è¿”å›åé€šçŸ¥ï¼šé€šè¿‡æ³¨è§£ç»‘å®šçš„æ–¹å¼è·å–è¿”å›å€¼
  - ç¯ç»•é€šçŸ¥ï¼šç›´æ¥æ¥æ”¶
- è·å–åˆ‡å…¥ç‚¹æ–¹æ³•è¿è¡Œå¼‚å¸¸ä¿¡æ¯ï¼Œå‰ç½®å’Œè¿”å›åé€šçŸ¥æ˜¯ä¸ä¼šæœ‰ï¼Œåç½®é€šçŸ¥å¯æœ‰å¯æ— ï¼Œæ‰€ä»¥ä¸åšç ”ç©¶
  - æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ï¼šé€šè¿‡æ³¨è§£ç»‘å®šçš„æ–¹å¼è·å–è¿”å›å€¼
  - ç¯ç»•é€šçŸ¥ï¼šç›´æ¥try catch

## AOPäº‹åŠ¡ç®¡ç†

### Springäº‹åŠ¡ç®€ä»‹

#### ç›¸å…³æ¦‚å¿µä»‹ç»

- äº‹åŠ¡ä½œç”¨ï¼šåœ¨æ•°æ®å±‚ä¿éšœä¸€ç³»åˆ—çš„æ•°æ®åº“æ“ä½œ**åŒæˆåŠŸåŒå¤±è´¥**
- Springäº‹åŠ¡ä½œç”¨ï¼šåœ¨æ•°æ®å±‚æˆ–**ä¸šåŠ¡å±‚**ä¿éšœä¸€ç³»åˆ—çš„æ•°æ®åº“æ“ä½œåŒæˆåŠŸåŒå¤±è´¥

æ•°æ®å±‚æœ‰äº‹åŠ¡æˆ‘ä»¬å¯ä»¥ç†è§£ï¼Œä¸ºä»€ä¹ˆä¸šåŠ¡å±‚ä¹Ÿéœ€è¦å¤„ç†äº‹åŠ¡å‘¢?

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œ

* è½¬è´¦ä¸šåŠ¡ä¼šæœ‰ä¸¤æ¬¡æ•°æ®å±‚çš„è°ƒç”¨ï¼Œä¸€æ¬¡æ˜¯åŠ é’±ä¸€æ¬¡æ˜¯å‡é’±
* æŠŠäº‹åŠ¡æ”¾åœ¨æ•°æ®å±‚ï¼ŒåŠ é’±å’Œå‡é’±å°±æœ‰ä¸¤ä¸ªäº‹åŠ¡
* æ²¡åŠæ³•ä¿è¯åŠ é’±å’Œå‡é’±åŒæ—¶æˆåŠŸæˆ–è€…åŒæ—¶å¤±è´¥
* è¿™ä¸ªæ—¶å€™å°±éœ€è¦å°†äº‹åŠ¡æ”¾åœ¨ä¸šåŠ¡å±‚è¿›è¡Œå¤„ç†ã€‚

Springä¸ºäº†ç®¡ç†äº‹åŠ¡ï¼Œæä¾›äº†ä¸€ä¸ªå¹³å°äº‹åŠ¡ç®¡ç†å™¨`PlatformTransactionManager`

![1630243651541](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640131.png)

commitæ˜¯ç”¨æ¥æäº¤äº‹åŠ¡ï¼Œrollbackæ˜¯ç”¨æ¥å›æ»šäº‹åŠ¡ã€‚

PlatformTransactionManageråªæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒSpringè¿˜ä¸ºå…¶æä¾›äº†ä¸€ä¸ªå…·ä½“çš„å®ç°:

![1630243993380](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640132.png)

ä»åç§°ä¸Šå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åªéœ€è¦ç»™å®ƒä¸€ä¸ªDataSourceå¯¹è±¡ï¼Œå®ƒå°±å¯ä»¥å¸®ä½ å»åœ¨ä¸šåŠ¡å±‚ç®¡ç†äº‹åŠ¡ã€‚å…¶å†…éƒ¨é‡‡ç”¨çš„æ˜¯JDBCçš„äº‹åŠ¡ã€‚æ‰€ä»¥è¯´å¦‚æœä½ æŒä¹…å±‚é‡‡ç”¨çš„æ˜¯JDBCç›¸å…³çš„æŠ€æœ¯ï¼Œå°±å¯ä»¥é‡‡ç”¨è¿™ä¸ªäº‹åŠ¡ç®¡ç†å™¨æ¥ç®¡ç†ä½ çš„äº‹åŠ¡ã€‚è€ŒMybatiså†…éƒ¨é‡‡ç”¨çš„å°±æ˜¯JDBCçš„äº‹åŠ¡ï¼Œæ‰€ä»¥åæœŸæˆ‘ä»¬Springæ•´åˆMybatiså°±é‡‡ç”¨çš„è¿™ä¸ªDataSourceTransactionManageräº‹åŠ¡ç®¡ç†å™¨ã€‚

#### 6.1.2 è½¬è´¦æ¡ˆä¾‹-éœ€æ±‚åˆ†æ

æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹æ¥å­¦ä¹ ä¸‹Springæ˜¯å¦‚ä½•æ¥ç®¡ç†äº‹åŠ¡çš„ã€‚

å…ˆæ¥åˆ†æä¸‹éœ€æ±‚:

éœ€æ±‚: å®ç°ä»»æ„ä¸¤ä¸ªè´¦æˆ·é—´è½¬è´¦æ“ä½œ

éœ€æ±‚å¾®ç¼©: Aè´¦æˆ·å‡é’±ï¼ŒBè´¦æˆ·åŠ é’±

ä¸ºäº†å®ç°ä¸Šè¿°çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸‹é¢æ­¥éª¤æ¥å®ç°ä¸‹:
â‘ ï¼šæ•°æ®å±‚æä¾›åŸºç¡€æ“ä½œï¼ŒæŒ‡å®šè´¦æˆ·å‡é’±ï¼ˆoutMoneyï¼‰ï¼ŒæŒ‡å®šè´¦æˆ·åŠ é’±ï¼ˆinMoneyï¼‰

â‘¡ï¼šä¸šåŠ¡å±‚æä¾›è½¬è´¦æ“ä½œï¼ˆtransferï¼‰ï¼Œè°ƒç”¨å‡é’±ä¸åŠ é’±çš„æ“ä½œ

â‘¢ï¼šæä¾›2ä¸ªè´¦å·å’Œæ“ä½œé‡‘é¢æ‰§è¡Œè½¬è´¦æ“ä½œ

â‘£ï¼šåŸºäºSpringæ•´åˆMyBatisç¯å¢ƒæ­å»ºä¸Šè¿°æ“ä½œ

#### 6.1.3 è½¬è´¦æ¡ˆä¾‹-ç¯å¢ƒæ­å»º

##### æ­¥éª¤1:å‡†å¤‡æ•°æ®åº“è¡¨

ä¹‹å‰æˆ‘ä»¬åœ¨æ•´åˆMybatisçš„æ—¶å€™å·²ç»åˆ›å»ºäº†è¿™ä¸ªè¡¨,å¯ä»¥ç›´æ¥ä½¿ç”¨

```sql
create database spring_db character set utf8;
use spring_db;
create table tbl_account(
    id int primary key auto_increment,
    name varchar(35),
    money double
);
insert into tbl_account values(1,'Tom',1000);
insert into tbl_account values(2,'Jerry',1000);
```

##### æ­¥éª¤2:åˆ›å»ºé¡¹ç›®å¯¼å…¥jaråŒ…

é¡¹ç›®çš„pom.xmlæ·»åŠ ç›¸å…³ä¾èµ–

```xml
<dependencies>
    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-context</artifactId>
      <version>5.2.10.RELEASE</version>
    </dependency>
    <dependency>
      <groupId>com.alibaba</groupId>
      <artifactId>druid</artifactId>
      <version>1.1.16</version>
    </dependency>

    <dependency>
      <groupId>org.mybatis</groupId>
      <artifactId>mybatis</artifactId>
      <version>3.5.6</version>
    </dependency>

    <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
      <version>5.1.47</version>
    </dependency>

    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-jdbc</artifactId>
      <version>5.2.10.RELEASE</version>
    </dependency>

    <dependency>
      <groupId>org.mybatis</groupId>
      <artifactId>mybatis-spring</artifactId>
      <version>1.3.0</version>
    </dependency>

    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.12</version>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.springframework</groupId>
      <artifactId>spring-test</artifactId>
      <version>5.2.10.RELEASE</version>
    </dependency>

  </dependencies>
```

##### æ­¥éª¤3:æ ¹æ®è¡¨åˆ›å»ºæ¨¡å‹ç±»

```java
public class Account implements Serializable {

    private Integer id;
    private String name;
    private Double money;
	//setter...getter...toString...æ–¹æ³•ç•¥    
}
```

##### æ­¥éª¤4:åˆ›å»ºDaoæ¥å£

```java
public interface AccountDao {

    @Update("update tbl_account set money = money + #{money} where name = #{name}")
    void inMoney(@Param("name") String name, @Param("money") Double money);

    @Update("update tbl_account set money = money - #{money} where name = #{name}")
    void outMoney(@Param("name") String name, @Param("money") Double money);
}
```

##### æ­¥éª¤5:åˆ›å»ºServiceæ¥å£å’Œå®ç°ç±»

```java
public interface AccountService {
    /**
     * è½¬è´¦æ“ä½œ
     * @param out ä¼ å‡ºæ–¹
     * @param in è½¬å…¥æ–¹
     * @param money é‡‘é¢
     */
    public void transfer(String out,String in ,Double money) ;
}

@Service
public class AccountServiceImpl implements AccountService {

    @Autowired
    private AccountDao accountDao;

    public void transfer(String out,String in ,Double money) {
        accountDao.outMoney(out,money);
        accountDao.inMoney(in,money);
    }

}
```

##### æ­¥éª¤6:æ·»åŠ jdbc.propertiesæ–‡ä»¶

```properties
jdbc.driver=com.mysql.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/spring_db?useSSL=false
jdbc.username=root
jdbc.password=root
```

##### æ­¥éª¤7:åˆ›å»ºJdbcConfigé…ç½®ç±»

```java
public class JdbcConfig {
    @Value("${jdbc.driver}")
    private String driver;
    @Value("${jdbc.url}")
    private String url;
    @Value("${jdbc.username}")
    private String userName;
    @Value("${jdbc.password}")
    private String password;

    @Bean
    public DataSource dataSource(){
        DruidDataSource ds = new DruidDataSource();
        ds.setDriverClassName(driver);
        ds.setUrl(url);
        ds.setUsername(userName);
        ds.setPassword(password);
        return ds;
    }
}
```

##### æ­¥éª¤8:åˆ›å»ºMybatisConfigé…ç½®ç±»

```java
//æ­£å¸¸çš„mybatisé…ç½®ç±»
public class MybatisConfig {
    @Bean
    public SqlSessionFactoryBean sqlSessionFactory(DataSource dataSource){
        SqlSessionFactoryBean ssfb = new SqlSessionFactoryBean();
        ssfb.setTypeAliasesPackage("com.itheima.domain");
        ssfb.setDataSource(dataSource);
        return ssfb;
    }
    @Bean
    public MapperScannerConfigurer mapperScannerConfigurer(){
        MapperScannerConfigurer msc = new MapperScannerConfigurer();
        msc.setBasePackage("com.itheima.dao");
        return msc;
    }
}
```

##### æ­¥éª¤9:åˆ›å»ºSpringConfigé…ç½®ç±»

```java
@Configuration
@ComponentScan("com.itheima")
@PropertySource("classpath:jdbc.properties")
@Import({JdbcConfig.class,MybatisConfig.class})
public class SpringConfig {
}

```

##### æ­¥éª¤10:ç¼–å†™æµ‹è¯•ç±»

```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(classes = SpringConfig.class)
public class AccountServiceTest {

    @Autowired
    private AccountService accountService;

    @Test
    public void testTransfer() throws IOException {
        accountService.transfer("Tom","Jerry",100D);
    }

}
```

æœ€ç»ˆåˆ›å»ºå¥½çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹:

![1630247220645](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640133.png)

#### 6.1.4 äº‹åŠ¡ç®¡ç†

ä¸Šè¿°ç¯å¢ƒï¼Œè¿è¡Œå•å…ƒæµ‹è¯•ç±»ï¼Œä¼šæ‰§è¡Œè½¬è´¦æ“ä½œï¼Œ`Tom`çš„è´¦æˆ·ä¼šå‡å°‘100ï¼Œ`Jerry`çš„è´¦æˆ·ä¼šåŠ 100ã€‚

è¿™æ˜¯**æ­£å¸¸æƒ…å†µ**ä¸‹çš„è¿è¡Œç»“æœï¼Œä½†æ˜¯å¦‚æœåœ¨è½¬è´¦çš„è¿‡ç¨‹ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œå¦‚:

```java
@Service
public class AccountServiceImpl implements AccountService {

    @Autowired
    private AccountDao accountDao;

    public void transfer(String out,String in ,Double money) {
        //å¦‚æœä¸è¿›è¡Œäº‹åŠ¡ç®¡ç†ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°åªå‡å°‘ä¸å¢åŠ çš„æ•ˆæœ
        accountDao.outMoney(out,money);
        int i = 1/0;
        accountDao.inMoney(in,money);
    }

}
```

è¿™ä¸ªæ—¶å€™å°±æ¨¡æ‹Ÿäº†è½¬è´¦è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸çš„æƒ…å†µï¼Œæ­£ç¡®çš„æ“ä½œåº”è¯¥æ˜¯è½¬è´¦å‡ºé—®é¢˜äº†ï¼Œ`Tom`åº”è¯¥è¿˜æ˜¯900ï¼Œ`Jerry`åº”è¯¥è¿˜æ˜¯1100ï¼Œä½†æ˜¯çœŸæ­£è¿è¡Œåä¼šå‘ç°ï¼Œå¹¶æ²¡æœ‰åƒæˆ‘ä»¬æƒ³è±¡çš„é‚£æ ·ï¼Œ`Tom`è´¦æˆ·ä¸º800è€Œ`Jerry`è¿˜æ˜¯1100,100å—é’±å‡­ç©ºæ¶ˆæ¯äº†ï¼Œé“¶è¡Œä¹ç–¯äº†ã€‚å¦‚æœæŠŠè½¬è´¦æ¢ä¸ªé¡ºåºï¼Œé“¶è¡Œå°±è¯¥å“­äº†ã€‚

ä¸ç®¡å“ªç§æƒ…å†µï¼Œéƒ½æ˜¯ä¸å…è®¸å‡ºç°çš„ï¼Œå¯¹åˆšæ‰çš„ç»“æœæˆ‘ä»¬åšä¸€ä¸ªåˆ†æ:

â‘ ï¼šç¨‹åºæ­£å¸¸æ‰§è¡Œæ—¶ï¼Œè´¦æˆ·é‡‘é¢Aå‡BåŠ ï¼Œæ²¡æœ‰é—®é¢˜

â‘¡ï¼šç¨‹åºå‡ºç°å¼‚å¸¸åï¼Œè½¬è´¦å¤±è´¥ï¼Œä½†æ˜¯å¼‚å¸¸ä¹‹å‰æ“ä½œæˆåŠŸï¼Œå¼‚å¸¸ä¹‹åæ“ä½œå¤±è´¥ï¼Œæ•´ä½“ä¸šåŠ¡å¤±è´¥

å½“ç¨‹åºå‡ºé—®é¢˜åï¼Œæˆ‘ä»¬éœ€è¦è®©äº‹åŠ¡è¿›è¡Œå›æ»šï¼Œè€Œä¸”è¿™ä¸ªäº‹åŠ¡åº”è¯¥æ˜¯åŠ åœ¨ä¸šåŠ¡å±‚ä¸Šï¼Œè€ŒSpringçš„äº‹åŠ¡ç®¡ç†å°±æ˜¯ç”¨æ¥è§£å†³è¿™ç±»é—®é¢˜çš„ã€‚

Springäº‹åŠ¡ç®¡ç†å…·ä½“çš„å®ç°æ­¥éª¤ä¸º:

##### æ­¥éª¤1:åœ¨éœ€è¦è¢«äº‹åŠ¡ç®¡ç†çš„æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£

```java
public interface AccountService {
    /**
     * è½¬è´¦æ“ä½œ
     * @param out ä¼ å‡ºæ–¹
     * @param in è½¬å…¥æ–¹
     * @param money é‡‘é¢
     */
    //é…ç½®å½“å‰æ¥å£æ–¹æ³•å…·æœ‰äº‹åŠ¡
    public void transfer(String out,String in ,Double money) ;
}

@Service
public class AccountServiceImpl implements AccountService {

    @Autowired
    private AccountDao accountDao;
	@Transactional
    public void transfer(String out,String in ,Double money) {
        accountDao.outMoney(out,money);
        int i = 1/0;
        accountDao.inMoney(in,money);
    }

}
```

**æ³¨æ„:**

@Transactionalå¯ä»¥å†™åœ¨æ¥å£ç±»ä¸Šã€æ¥å£æ–¹æ³•ä¸Šã€å®ç°ç±»ä¸Šå’Œå®ç°ç±»æ–¹æ³•ä¸Š

* å†™åœ¨æ¥å£ç±»ä¸Šï¼Œè¯¥æ¥å£çš„æ‰€æœ‰å®ç°ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šæœ‰äº‹åŠ¡
* å†™åœ¨æ¥å£æ–¹æ³•ä¸Šï¼Œè¯¥æ¥å£çš„æ‰€æœ‰å®ç°ç±»çš„è¯¥æ–¹æ³•éƒ½ä¼šæœ‰äº‹åŠ¡
* å†™åœ¨å®ç°ç±»ä¸Šï¼Œè¯¥ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šæœ‰äº‹åŠ¡
* å†™åœ¨å®ç°ç±»æ–¹æ³•ä¸Šï¼Œè¯¥æ–¹æ³•ä¸Šæœ‰äº‹åŠ¡
* **å»ºè®®å†™åœ¨å®ç°ç±»æˆ–å®ç°ç±»çš„æ–¹æ³•ä¸Š**

##### æ­¥éª¤2:åœ¨JdbcConfigç±»ä¸­é…ç½®äº‹åŠ¡ç®¡ç†å™¨

```java
public class JdbcConfig {
    @Value("${jdbc.driver}")
    private String driver;
    @Value("${jdbc.url}")
    private String url;
    @Value("${jdbc.username}")
    private String userName;
    @Value("${jdbc.password}")
    private String password;

    @Bean
    public DataSource dataSource(){
        DruidDataSource ds = new DruidDataSource();
        ds.setDriverClassName(driver);
        ds.setUrl(url);
        ds.setUsername(userName);
        ds.setPassword(password);
        return ds;
    }

    //é…ç½®äº‹åŠ¡ç®¡ç†å™¨ï¼Œmybatisä½¿ç”¨çš„æ˜¯jdbcäº‹åŠ¡
    @Bean
    public PlatformTransactionManager transactionManager(DataSource dataSource){
        DataSourceTransactionManager transactionManager = new DataSourceTransactionManager();
        transactionManager.setDataSource(dataSource);
        return transactionManager;
    }
}
```

**æ³¨æ„ï¼š**äº‹åŠ¡ç®¡ç†å™¨è¦æ ¹æ®ä½¿ç”¨æŠ€æœ¯è¿›è¡Œé€‰æ‹©ï¼ŒMybatisæ¡†æ¶ä½¿ç”¨çš„æ˜¯JDBCäº‹åŠ¡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`DataSourceTransactionManager`

##### æ­¥éª¤3ï¼šå¼€å¯äº‹åŠ¡æ³¨è§£

åœ¨SpringConfigçš„é…ç½®ç±»ä¸­å¼€å¯

```java
@Configuration
@ComponentScan("com.itheima")
@PropertySource("classpath:jdbc.properties")
@Import({JdbcConfig.class,MybatisConfig.class
//å¼€å¯æ³¨è§£å¼äº‹åŠ¡é©±åŠ¨
@EnableTransactionManagement
public class SpringConfig {
}

```

##### æ­¥éª¤4:è¿è¡Œæµ‹è¯•ç±»

ä¼šå‘ç°åœ¨è½¬æ¢çš„ä¸šåŠ¡å‡ºç°é”™è¯¯åï¼Œäº‹åŠ¡å°±å¯ä»¥æ§åˆ¶å›é¡¾ï¼Œä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€‚

##### çŸ¥è¯†ç‚¹1ï¼š@EnableTransactionManagement

| åç§° | @EnableTransactionManagement           |
| ---- | -------------------------------------- |
| ç±»å‹ | é…ç½®ç±»æ³¨è§£                             |
| ä½ç½® | é…ç½®ç±»å®šä¹‰ä¸Šæ–¹                         |
| ä½œç”¨ | è®¾ç½®å½“å‰Springç¯å¢ƒä¸­å¼€å¯æ³¨è§£å¼äº‹åŠ¡æ”¯æŒ |

##### çŸ¥è¯†ç‚¹2ï¼š@Transactional   

| åç§° | @Transactional                                               |
| ---- | ------------------------------------------------------------ |
| ç±»å‹ | æ¥å£æ³¨è§£  ç±»æ³¨è§£  æ–¹æ³•æ³¨è§£                                   |
| ä½ç½® | ä¸šåŠ¡å±‚æ¥å£ä¸Šæ–¹  ä¸šåŠ¡å±‚å®ç°ç±»ä¸Šæ–¹  ä¸šåŠ¡æ–¹æ³•ä¸Šæ–¹               |
| ä½œç”¨ | ä¸ºå½“å‰ä¸šåŠ¡å±‚æ–¹æ³•æ·»åŠ äº‹åŠ¡ï¼ˆå¦‚æœè®¾ç½®åœ¨ç±»æˆ–æ¥å£ä¸Šæ–¹åˆ™ç±»æˆ–æ¥å£ä¸­æ‰€æœ‰æ–¹æ³•å‡æ·»åŠ äº‹åŠ¡ï¼‰ |

#### æ€»ç»“

ä¸ºäº†å®ç°ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

1. åœ¨éœ€è¦äº‹åŠ¡ç®¡ç†çš„åœ°æ–¹åŠ ä¸Šäº‹åŠ¡Transactionalæ³¨è§£
2. åœ¨é…ç½®ç±»ä¸­æ·»åŠ ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨çš„beanå¯¹è±¡
3. åœ¨ä¸»é…ç½®ç±»ä¸­å¼€å¯äº‹åŠ¡çš„å¼€å…³ï¼ˆEnableTransactionManagementï¼‰

### Springäº‹åŠ¡è§’è‰²

è¿™èŠ‚ä¸­æˆ‘ä»¬é‡ç‚¹è¦ç†è§£ä¸¤ä¸ªæ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯`äº‹åŠ¡ç®¡ç†å‘˜`å’Œ`äº‹åŠ¡åè°ƒå‘˜`ã€‚

1. æœªå¼€å¯Springäº‹åŠ¡ä¹‹å‰:

![1630248794837](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640134.png)

* AccountDaoçš„outMoneyå› ä¸ºæ˜¯ä¿®æ”¹æ“ä½œï¼Œä¼šå¼€å¯ä¸€ä¸ªäº‹åŠ¡T1
* AccountDaoçš„inMoneyå› ä¸ºæ˜¯ä¿®æ”¹æ“ä½œï¼Œä¼šå¼€å¯ä¸€ä¸ªäº‹åŠ¡T2
* AccountServiceçš„transferæ²¡æœ‰äº‹åŠ¡ï¼Œ
  * è¿è¡Œè¿‡ç¨‹ä¸­å¦‚æœæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™T1å’ŒT2éƒ½æ­£å¸¸æäº¤ï¼Œæ•°æ®æ­£ç¡®
  * å¦‚æœåœ¨ä¸¤ä¸ªæ–¹æ³•ä¸­é—´æŠ›å‡ºå¼‚å¸¸ï¼ŒT1å› ä¸ºæ‰§è¡ŒæˆåŠŸæäº¤äº‹åŠ¡ï¼ŒT2å› ä¸ºæŠ›å¼‚å¸¸ä¸ä¼šè¢«æ‰§è¡Œ
  * å°±ä¼šå¯¼è‡´æ•°æ®å‡ºç°é”™è¯¯

2. å¼€å¯Springçš„äº‹åŠ¡ç®¡ç†å

![1630249111055](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640135.png)

* transferä¸Šæ·»åŠ äº†@Transactionalæ³¨è§£ï¼Œåœ¨è¯¥æ–¹æ³•ä¸Šå°±ä¼šæœ‰ä¸€ä¸ªäº‹åŠ¡T
* AccountDaoçš„outMoneyæ–¹æ³•çš„äº‹åŠ¡T1**åŠ å…¥**åˆ°transferçš„äº‹åŠ¡Tä¸­
* AccountDaoçš„inMoneyæ–¹æ³•çš„äº‹åŠ¡T2**åŠ å…¥**åˆ°transferçš„äº‹åŠ¡Tä¸­
* è¿™æ ·å°±ä¿è¯ä»–ä»¬åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå½“ä¸šåŠ¡å±‚ä¸­å‡ºç°å¼‚å¸¸ï¼Œæ•´ä¸ªäº‹åŠ¡å°±ä¼šå›æ»šï¼Œä¿è¯æ•°æ®çš„å‡†ç¡®æ€§ã€‚

é€šè¿‡ä¸Šé¢ä¾‹å­çš„åˆ†æï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹æ¦‚å¿µ:

- äº‹åŠ¡ç®¡ç†å‘˜ï¼šå‘èµ·äº‹åŠ¡æ–¹ï¼Œåœ¨Springä¸­é€šå¸¸æŒ‡ä»£ä¸šåŠ¡å±‚å¼€å¯äº‹åŠ¡çš„æ–¹æ³•
- äº‹åŠ¡åè°ƒå‘˜ï¼šåŠ å…¥äº‹åŠ¡æ–¹ï¼Œåœ¨Springä¸­é€šå¸¸æŒ‡ä»£æ•°æ®å±‚æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸šåŠ¡å±‚æ–¹æ³•

**æ³¨æ„:**

ç›®å‰çš„äº‹åŠ¡ç®¡ç†æ˜¯åŸºäº`DataSourceTransactionManager`å’Œ`SqlSessionFactoryBean`ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ•°æ®æºã€‚å¦åˆ™äº‹åŠ¡ç®¡ç†å°±ä¼šå¤±è´¥ï¼Œå› ä¸ºç®¡ç†çš„ä¸æ˜¯åŒä¸€ä¸ªæ•°æ®æºï¼ŒçœŸæ­£æ•°æ®æŸ¥è¯¢çš„æ•°æ®æºå°±ä¸ä¼šå—åˆ°äº‹åŠ¡çš„æ§åˆ¶

### Springäº‹åŠ¡å±æ€§

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†ä¸¤ä¸ªæ¦‚å¿µï¼Œäº‹åŠ¡çš„ç®¡ç†å‘˜å’Œäº‹åŠ¡çš„ååŒå‘˜ï¼Œå¯¹äºè¿™ä¸¤ä¸ªæ¦‚å¿µå…·ä½“åšä»€ä¹ˆçš„ï¼Œæˆ‘ä»¬å¾…ä¼šé€šè¿‡æ¡ˆä¾‹æ¥ä½¿ç”¨ä¸‹ã€‚é™¤äº†è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œè¿˜æœ‰å°±æ˜¯äº‹åŠ¡çš„å…¶ä»–ç›¸å…³é…ç½®éƒ½æœ‰å“ªäº›ï¼Œå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦ä¹ çš„å†…å®¹ã€‚

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ ä¸‰éƒ¨åˆ†å†…å®¹`äº‹åŠ¡é…ç½®`ã€`è½¬è´¦ä¸šåŠ¡è¿½åŠ æ—¥å¿—`ã€`äº‹åŠ¡ä¼ æ’­è¡Œä¸º`ã€‚

#### äº‹åŠ¡é…ç½®

![1630250069844](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640136.png)

ä¸Šé¢è¿™äº›å±æ€§éƒ½å¯ä»¥åœ¨`@Transactional`æ³¨è§£çš„å‚æ•°ä¸Šè¿›è¡Œè®¾ç½®ã€‚

* readOnlyï¼štrueåªè¯»äº‹åŠ¡ï¼Œfalseè¯»å†™äº‹åŠ¡ï¼Œå¢åˆ æ”¹è¦è®¾ä¸ºfalse,æŸ¥è¯¢è®¾ä¸ºtrueã€‚

* timeout:è®¾ç½®è¶…æ—¶æ—¶é—´å•ä½ç§’ï¼Œåœ¨å¤šé•¿æ—¶é—´ä¹‹å†…äº‹åŠ¡æ²¡æœ‰æäº¤æˆåŠŸå°±è‡ªåŠ¨å›æ»šï¼Œ-1è¡¨ç¤ºä¸è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚

* rollbackFor:å½“å‡ºç°æŒ‡å®šå¼‚å¸¸è¿›è¡Œäº‹åŠ¡å›æ»š

* noRollbackFor:å½“å‡ºç°æŒ‡å®šå¼‚å¸¸ä¸è¿›è¡Œäº‹åŠ¡å›æ»š

  * æ€è€ƒ:å‡ºç°å¼‚å¸¸äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»šï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬ä¹‹å‰å°±å·²ç»çŸ¥é“çš„

  * noRollbackForæ˜¯è®¾å®šå¯¹äºæŒ‡å®šçš„å¼‚å¸¸ä¸å›æ»šï¼Œè¿™ä¸ªå¥½ç†è§£

  * rollbackForæ˜¯æŒ‡å®šå›æ»šå¼‚å¸¸ï¼Œå¯¹äºå¼‚å¸¸äº‹åŠ¡ä¸åº”è¯¥éƒ½å›æ»šä¹ˆï¼Œä¸ºä»€ä¹ˆè¿˜è¦æŒ‡å®š?

    * è¿™å—éœ€è¦æ›´æ­£ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å¼‚å¸¸éƒ½ä¼šå›æ»šäº‹åŠ¡ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç å°±ä¸ä¼šå›æ»š

      ```java
      public interface AccountService {
          /**
           * è½¬è´¦æ“ä½œ
           * @param out ä¼ å‡ºæ–¹
           * @param in è½¬å…¥æ–¹
           * @param money é‡‘é¢
           */
          //é…ç½®å½“å‰æ¥å£æ–¹æ³•å…·æœ‰äº‹åŠ¡
          public void transfer(String out,String in ,Double money) throws IOException;
      }
      
      @Service
      public class AccountServiceImpl implements AccountService {
      
          @Autowired
          private AccountDao accountDao;
      	@Transactional
          public void transfer(String out,String in ,Double money) throws IOException{
              accountDao.outMoney(out,money);
              //int i = 1/0; //è¿™ä¸ªå¼‚å¸¸äº‹åŠ¡ä¼šå›æ»š
              if(true){
                  throw new IOException(); //è¿™ä¸ªå¼‚å¸¸äº‹åŠ¡å°±ä¸ä¼šå›æ»š
              }
              accountDao.inMoney(in,money);
          }
      
      }
      ```

* å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ï¼ŒSpringçš„äº‹åŠ¡åªä¼šå¯¹`Errorå¼‚å¸¸`å’Œ`RuntimeExceptionå¼‚å¸¸`åŠå…¶å­ç±»è¿›è¡Œäº‹åŠ¡å›æ»šï¼Œå…¶ä»–çš„å¼‚å¸¸ç±»å‹æ˜¯ä¸ä¼šå›æ»šçš„ï¼Œå¯¹åº”IOExceptionä¸ç¬¦åˆä¸Šè¿°æ¡ä»¶æ‰€ä»¥ä¸å›æ»š
  
  * æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨rollbackForå±æ€§æ¥è®¾ç½®å‡ºç°IOExceptionå¼‚å¸¸å›æ»š
  
    ```java
    @Service
    public class AccountServiceImpl implements AccountService {
    
        @Autowired
        private AccountDao accountDao;
    	 @Transactional(rollbackFor = {IOException.class})
        public void transfer(String out,String in ,Double money) throws IOException{
            accountDao.outMoney(out,money);
            //int i = 1/0; //è¿™ä¸ªå¼‚å¸¸äº‹åŠ¡ä¼šå›æ»š
            if(true){
                throw new IOException(); //è¿™ä¸ªå¼‚å¸¸äº‹åŠ¡å°±ä¸ä¼šå›æ»š
            }
            accountDao.inMoney(in,money);
        }
    
    }
    ```
  
* rollbackForClassNameç­‰åŒäºrollbackFor,åªä¸è¿‡å±æ€§ä¸ºå¼‚å¸¸çš„ç±»å…¨åå­—ç¬¦ä¸²

* noRollbackForClassNameç­‰åŒäºnoRollbackForï¼Œåªä¸è¿‡å±æ€§ä¸ºå¼‚å¸¸çš„ç±»å…¨åå­—ç¬¦ä¸²

* isolationè®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«

  * DEFAULT   :é»˜è®¤éš”ç¦»çº§åˆ«, ä¼šé‡‡ç”¨æ•°æ®åº“çš„éš”ç¦»çº§åˆ«
  * READ_UNCOMMITTED : è¯»æœªæäº¤
  * READ_COMMITTED : è¯»å·²æäº¤
  * REPEATABLE_READ : é‡å¤è¯»å–
  * SERIALIZABLE: ä¸²è¡ŒåŒ–

ä»‹ç»å®Œä¸Šè¿°å±æ€§åï¼Œè¿˜æœ‰æœ€åä¸€ä¸ªäº‹åŠ¡çš„**ä¼ æ’­è¡Œä¸º**ï¼Œä¸ºäº†è®²è§£è¯¥å±æ€§çš„è®¾ç½®ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆä¸‹é¢çš„æ¡ˆä¾‹ã€‚


#### è½¬è´¦ä¸šåŠ¡è¿½åŠ æ—¥å¿—æ¡ˆä¾‹

##### éœ€æ±‚åˆ†æ

åœ¨å‰é¢çš„è½¬æ¡ˆä¾‹çš„åŸºç¡€ä¸Šæ·»åŠ æ–°çš„éœ€æ±‚ï¼Œå®Œæˆè½¬è´¦å**è®°å½•æ—¥å¿—**ã€‚

- éœ€æ±‚ï¼šå®ç°ä»»æ„ä¸¤ä¸ªè´¦æˆ·é—´è½¬è´¦æ“ä½œï¼Œå¹¶å¯¹æ¯æ¬¡è½¬è´¦æ“ä½œåœ¨æ•°æ®åº“è¿›è¡Œç•™ç—•
- éœ€æ±‚å¾®ç¼©ï¼šAè´¦æˆ·å‡é’±ï¼ŒBè´¦æˆ·åŠ é’±ï¼Œæ•°æ®åº“è®°å½•æ—¥å¿—

åŸºäºä¸Šè¿°çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸‹è¯¥å¦‚ä½•å®ç°:

â‘ ï¼šåŸºäºè½¬è´¦æ“ä½œæ¡ˆä¾‹æ·»åŠ æ—¥å¿—æ¨¡å—ï¼Œå®ç°æ•°æ®åº“ä¸­è®°å½•æ—¥å¿—

â‘¡ï¼šä¸šåŠ¡å±‚è½¬è´¦æ“ä½œï¼ˆtransferï¼‰ï¼Œè°ƒç”¨å‡é’±ã€åŠ é’±ä¸è®°å½•æ—¥å¿—åŠŸèƒ½

éœ€è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ï¼Œæˆ‘ä»¬è¿™ä¸ªæ¡ˆä¾‹çš„é¢„æœŸæ•ˆæœä¸º:

> **æ— è®º**è½¬è´¦æ“ä½œæ˜¯å¦æˆåŠŸï¼Œå‡è¿›è¡Œè½¬è´¦æ“ä½œçš„æ—¥å¿—ç•™ç—•

##### ç¯å¢ƒå‡†å¤‡

è¯¥ç¯å¢ƒæ˜¯åŸºäºè½¬è´¦ç¯å¢ƒæ¥å®Œæˆçš„ï¼Œæ‰€ä»¥ç¯å¢ƒçš„å‡†å¤‡å¯ä»¥å‚è€ƒ`6.1.3çš„ç¯å¢ƒæ­å»ºæ­¥éª¤`ï¼Œåœ¨å…¶åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹å†™

###### æ­¥éª¤1:åˆ›å»ºæ—¥å¿—è¡¨

```sql
create table tbl_log(
   id int primary key auto_increment,
   info varchar(255),
   createDate datetime
)
```

###### æ­¥éª¤2:æ·»åŠ LogDaoæ¥å£

```java
public interface LogDao {
    @Insert("insert into tbl_log (info,createDate) values(#{info},now())")
    void log(String info);
}

```

###### æ­¥éª¤3:æ·»åŠ LogServiceæ¥å£ä¸å®ç°ç±»

```java
public interface LogService {
    void log(String out, String in, Double money);
}
@Service
public class LogServiceImpl implements LogService {

    @Autowired
    private LogDao logDao;
	@Transactional//è¡¨ç¤ºè®°å½•æ—¥å¿—çš„è¿‡ç¨‹ä¹Ÿå—åˆ°äº‹åŠ¡çš„æ§åˆ¶
    public void log(String out,String in,Double money ) {
        logDao.log("è½¬è´¦æ“ä½œç”±"+out+"åˆ°"+in+",é‡‘é¢ï¼š"+money);
    }
}
```

###### æ­¥éª¤4:åœ¨è½¬è´¦çš„ä¸šåŠ¡ä¸­æ·»åŠ è®°å½•æ—¥å¿—

```java
public interface AccountService {
    /**
     * è½¬è´¦æ“ä½œ
     * @param out ä¼ å‡ºæ–¹
     * @param in è½¬å…¥æ–¹
     * @param money é‡‘é¢
     */
    //é…ç½®å½“å‰æ¥å£æ–¹æ³•å…·æœ‰äº‹åŠ¡
    public void transfer(String out,String in ,Double money)throws IOException ;
}
@Service
public class AccountServiceImpl implements AccountService {

    @Autowired
    private AccountDao accountDao;
    @Autowired
    private LogService logService;
	@Transactional//ç¬¬ä¸€ä¸ªäº‹åŠ¡
    public void transfer(String out,String in ,Double money) {
        try{
            accountDao.outMoney(out,money);
            accountDao.inMoney(in,money);
        }finally {
            //ç¬¬äºŒä¸ªäº‹åŠ¡
            logService.log(out,in,money);
        }
    }

}
```

###### æ­¥éª¤5:è¿è¡Œç¨‹åº

* å½“ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œtbl_accountè¡¨ä¸­è½¬è´¦æˆåŠŸï¼Œtbl_logè¡¨ä¸­æ—¥å¿—è®°å½•æˆåŠŸ

* å½“è½¬è´¦ä¸šåŠ¡ä¹‹é—´å‡ºç°å¼‚å¸¸(int i =1/0),è½¬è´¦å¤±è´¥ï¼Œtbl_accountæˆåŠŸå›æ»šï¼Œä½†æ˜¯tbl_logè¡¨æœªæ·»åŠ æ•°æ®
* è¿™ä¸ªç»“æœå’Œæˆ‘ä»¬æƒ³è¦çš„ä¸ä¸€æ ·ï¼Œä»€ä¹ˆåŸå› ?è¯¥å¦‚ä½•è§£å†³?
* å¤±è´¥åŸå› :æ—¥å¿—çš„è®°å½•ä¸è½¬è´¦æ“ä½œ**éš¶å±åŒä¸€ä¸ªäº‹åŠ¡**ï¼ŒåŒæˆåŠŸåŒå¤±è´¥ï¼Œè®°å½•æ—¥å¿—çš„äº‹åŠ¡é»˜è®¤ä¼šåŠ å…¥åˆ°è½¬è´¦æ“ä½œçš„äº‹åŠ¡ä¸­
* æœ€ç»ˆæ•ˆæœ:æ— è®ºè½¬è´¦æ“ä½œæ˜¯å¦æˆåŠŸï¼Œæ—¥å¿—å¿…é¡»ä¿ç•™

#### äº‹åŠ¡ä¼ æ’­è¡Œä¸º

![1630253779575](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640137.png)

å¯¹äºä¸Šè¿°æ¡ˆä¾‹çš„åˆ†æ:

* logæ–¹æ³•ã€inMoneyæ–¹æ³•å’ŒoutMoneyæ–¹æ³•éƒ½å±äºå¢åˆ æ”¹ï¼Œåˆ†åˆ«æœ‰äº‹åŠ¡T1,T2,T3
* transferå› ä¸ºåŠ äº†@Transactionalæ³¨è§£ï¼Œä¹Ÿå¼€å¯äº†äº‹åŠ¡T
* å‰é¢æˆ‘ä»¬è®²è¿‡Springäº‹åŠ¡ä¼šæŠŠT1,T2,T3éƒ½åŠ å…¥åˆ°äº‹åŠ¡Tä¸­
* æ‰€ä»¥å½“è½¬è´¦å¤±è´¥åï¼Œæ‰€æœ‰çš„äº‹åŠ¡**éƒ½å›æ»š**ï¼Œå¯¼è‡´æ—¥å¿—æ²¡æœ‰è®°å½•ä¸‹æ¥
* è¿™å’Œæˆ‘ä»¬çš„éœ€æ±‚ä¸ç¬¦ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±æƒ³èƒ½ä¸èƒ½è®©logæ–¹æ³•å•ç‹¬æ˜¯ä¸€ä¸ªäº‹åŠ¡å‘¢?

è¦æƒ³è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±éœ€è¦ç”¨åˆ°**äº‹åŠ¡ä¼ æ’­**è¡Œä¸ºï¼Œæ‰€è°“çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæŒ‡çš„æ˜¯:

äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼šäº‹åŠ¡åè°ƒå‘˜å¯¹äº‹åŠ¡ç®¡ç†å‘˜æ‰€æºå¸¦äº‹åŠ¡çš„å¤„ç†æ€åº¦ã€‚

å…·ä½“å¦‚ä½•è§£å†³ï¼Œå°±éœ€è¦ç”¨åˆ°ä¹‹å‰æˆ‘ä»¬æ²¡æœ‰è¯´çš„`propagationå±æ€§`ã€‚

##### 1.ä¿®æ”¹logServiceæ”¹å˜äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º

```java
@Service
public class LogServiceImpl implements LogService {

    @Autowired
    private LogDao logDao;
	//propagationè®¾ç½®äº‹åŠ¡å±æ€§ï¼šä¼ æ’­è¡Œä¸ºè®¾ç½®ä¸ºå½“å‰æ“ä½œéœ€è¦æ–°äº‹åŠ¡
    //è¿™æ ·è®¾ç½®ä¹‹åï¼Œä¸ç®¡è°ƒç”¨æ­¤æ–¹æ³•çš„åœ°æ–¹æœ‰æ²¡æœ‰äº‹åŠ¡ï¼Œè¿™ä¸ªæ–¹æ³•éƒ½è‡ªå·±å•ç‹¬æˆä¸ºä¸€ä¸ªäº‹åŠ¡
    //ä¸ä¼šåŠ å…¥å…¶ä»–äº‹åŠ¡ä¸­
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void log(String out,String in,Double money ) {
        logDao.log("è½¬è´¦æ“ä½œç”±"+out+"åˆ°"+in+",é‡‘é¢ï¼š"+money);
    }
}
```

è¿è¡Œåï¼Œå°±èƒ½å®ç°æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œä¸ç®¡è½¬è´¦æ˜¯å¦æˆåŠŸï¼Œéƒ½ä¼šè®°å½•æ—¥å¿—ã€‚

##### 2.äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„å¯é€‰å€¼

![1630254257628](https://zzzi-img-1313100942.cos.ap-beijing.myqcloud.com/img/202310281640138.png)

å¯¹äºæˆ‘ä»¬å¼€å‘å®é™…ä¸­ä½¿ç”¨çš„è¯ï¼Œå› ä¸ºé»˜è®¤å€¼éœ€è¦äº‹åŠ¡æ˜¯å¸¸æ€çš„ã€‚æ ¹æ®å¼€å‘è¿‡ç¨‹é€‰æ‹©å…¶ä»–çš„å°±å¯ä»¥äº†ï¼Œä¾‹å¦‚æ¡ˆä¾‹ä¸­éœ€è¦æ–°äº‹åŠ¡å°±éœ€è¦æ‰‹å·¥é…ç½®ã€‚å…¶å®å…¥è´¦å’Œå‡ºè´¦æ“ä½œä¸Šä¹Ÿæœ‰äº‹åŠ¡ï¼Œé‡‡ç”¨çš„å°±æ˜¯é»˜è®¤å€¼ã€‚
